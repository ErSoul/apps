
pkgname=js
pkgver=52.2.1
_pkgver=52.2.1
pkgrel=2
pkgdesc="JavaScript interpreter and libraries"
arch=('x86_64')
url="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Releases/52"
license=('GPL2')
depends=('nspr' 'gcc-libs' 'libffi' 'readline' 'icu')
makedepends=('python2' 'zip' 'autoconf2.13')
source=("https://ftp.gnome.org/pub/gnome/teams/releng/tarballs-needing-help/mozjs/mozjs-52.2.1gnome1.tar.gz"
#source=("https://hg.mozilla.org/mozilla-unified/archive/FIREFOX_${_pkgver}.tar.bz2")
#source=("https://ftp.mozilla.org/pub/firefox/releases/${_pkgver}/source/firefox-${_pkgver}.source.tar.xz"
        'copy_headers.patch')
md5sums=('72bd9a715ed1ab70b2aebe92969f6b63'
         'a258b7a06260bb568f2d958631740b47')

#prepare() {
#  cd firefox-${_pkgver}
  
#  patch -p1 -i ${srcdir}/copy_headers.patch
#}

build() {
  cd mozjs-${_pkgver}gnome1/js/src
  # http://www.linuxfromscratch.org/blfs/view/svn/general/JS2.html needed for newer perl
  #sed -i 's/(defined\((@TEMPLATE_FILE)\))/\1/' config/milestone.pl

  unset CPPFLAGS

  autoconf-2.13
  ./configure --prefix=/usr \
       --disable-debug \
       --disable-debug-symbols \
       --disable-optimize \
       --disable-strip \
       --with-system-nspr \
       --with-system-zlib \
       --with-intl-api \
       --with-system-icu \
       --enable-readline \
       --enable-shared-js \
       --enable-tests \

  make
}

check() {
  cd mozjs-${_pkgver}gnome1/js/src
  
  #python2 tests/jstests.py -d -s -t 300 --no-progress ../../js/src/js/src/shell/js
  #python2 jit-test/jit_test.py -s -t 300 --no-progress ../../js/src/js/src/shell/js basic
}
  
  
package() {
  cd mozjs-${_pkgver}gnome1/js/src
  make DESTDIR=${pkgdir} install
  
  rm ${pkgdir}/usr/lib/libjs_static.ajs

  find ${pkgdir}/usr/{lib/pkgconfig,include} -type f -exec chmod -x {} +
}

