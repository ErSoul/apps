
pkgname=go
pkgver=1.4
pkgrel=1
pkgdesc='Google Go compiler and tools (release version)'
arch=('x86_64')
url="http://golang.org/"
license=('custom')
depends=('perl' 'gawk')
makedepends=('inetutils')
options=('!strip' '!emptydirs')
install=go.install
# check for versions: http://golang.org/dl/
source=("https://storage.googleapis.com/golang/${pkgname}$pkgver.linux-amd64.tar.gz"
        "$pkgname.sh")
md5sums=('9b44606c28c88a5c3d0cb4a36ce7de54'
         '5811c4ffcb2f381bd21da55bf1a79042')

build() {
  cd "$srcdir/$pkgname/src"

  export GOROOT=$srcdir/$pkgname-$pkgver
  export GOBIN=$GOROOT/bin
  export GOPATH=$srcdir/
  export GOROOT_FINAL="/usr/lib/go"
  export GOOS=linux

  bash make.bash
}

#check() {
 # cd "$srcdir/$pkgname"
  
  #export GOOS=linux
  #export GOARCH=amd64
  #export GOROOT="$srcdir/$pkgname"
  #export PATH="$srcdir/$pkgname/bin:$PATH"

  # TestSimpleMulticastListener will fail in standard chroot.
  #cd src && bash run.bash --no-rebuild || true
#}

package() {
  cd "$srcdir/$pkgname"
  
  export GOROOT="$srcdir/$pkgname"
  export PATH="$srcdir/$pkgname/bin:$PATH"

  cd "$srcdir/$pkgname"

  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/go/LICENSE"

  mkdir -p "$pkgdir/"{etc/profile.d,usr/{share/go,lib/go,lib/go/src,lib/go/site/src}}

  cp -r doc misc -t "$pkgdir/usr/share/go"
  ln -s /usr/share/go/doc "$pkgdir/usr/lib/go/doc"
  cp -a bin "$pkgdir/usr"
  cp -a pkg "$pkgdir/usr/lib/go"
  cp -a $GOROOT/src "$pkgdir/usr/lib/go"
  cp -a $GOROOT/src/cmd "$pkgdir/usr/lib/go/src/cmd"
  cp -a $GOROOT/src/lib9 "$pkgdir/usr/lib/go/src/"
  cp -a $GOROOT/lib "$pkgdir/usr/lib/go/"
  cp -a $GOROOT/include "$pkgdir/usr/lib/go/"

  install -Dm644 src/Make.* "$pkgdir/usr/lib/go/src"

  # Remove object files from target src dir
  find "$pkgdir/usr/lib/go/src/" -type f -name '*.[ao]' -delete
  find $pkgdir -type f -name sql.go -exec chmod -x {} \;
  find "$pkgdir/usr/lib/go/src" -type f -executable -delete

  # Headers for C modules
  install -Dm644 src/runtime/runtime.h \
    "$pkgdir/usr/lib/go/src/runtime/runtime.h"
  install -Dm644 src/runtime/cgocall.h \
    "$pkgdir/usr/lib/go/src/runtime/cgocall.h"

  # For packages that source /etc/profile.d/go.sh
  install -Dm755 "$srcdir/$pkgname.sh" "$pkgdir/etc/profile.d/$pkgname.sh"
  
  ln -sf /usr/bin $pkgdir/usr/lib/go/bin

  # For godoc
  install -Dm644 favicon.ico $pkgdir/usr/lib/go/favicon.ico

  rm -f "$pkgdir/usr/share/go/doc/articles/wiki/get.bin"
  install -Dm644 VERSION $pkgdir/usr/lib/go/VERSION
}
