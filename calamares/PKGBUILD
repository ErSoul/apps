
pkgname=calamares
pkgver=0.7.14
pkgrel=1
pkgdesc='Distribution-independent installer framework'
arch=('x86_64')
url='https://github.com/calamares/calamares'
license=('LGPL')
depends=('qt5-svg' 'kconfig' 'ki18n' 'kcoreaddons' 'solid' 'yaml-cpp'
         'parted' 'libatasmart' 'udisks2' 'polkit-qt5')
makedepends=('extra-cmake-modules' 'git' 'qt5-tools')
source=("git://github.com/KaOSx/calamares"
#source=("calamares.tar.xz"
        'displaymanager.conf'
        'locale.conf'
        'mount.conf'
        'prepare.conf'
        'settings.conf'
        'unpackfs.conf'
        'launch-calamares.sh'
        'installer.svg'
        'GreetingPage.diff'
        'CalamaresStyle.diff'
        'UEFI.diff'
        'JobQueue.diff')
md5sums=('SKIP'
         'ef69daa07bcd1e22b6f0bf3fdb5ef1b1'
         '6b793a81d051d5d0b00a6031ceb08308'
         'f9ddf31be579a7f280d8eabd839c72b2'
         'ebc235d4b2f9a425bf2161d7a252dce3'
         '0d87f1601e82e1b7a8ce8a2f7f63b033'
         '8b69a3a86923e2ee67a5a0725acb93e6'
         '2437e44479a54376ad9244d120369f6c'
         'd5c65f43e057054e9728810530c4a030'
         'f702efb102437531928af9b5b589e24e'
         '64d7df6bbc7c85441a90855a002b89e9'
         '62fa7d1231cc477a7ea98a857618aca2'
         '7117bc63a9bbd9ca5f2654d3fb772e1f')

prepare () {
  cd ${srcdir}/${pkgname}
  
  git submodule init
  git submodule update
  sed -i 's|Ext4|Xfs|' ${srcdir}/${pkgname}/src/modules/partition/tests/PartitionJobTests.cpp
  sed -i 's|Ext4|Xfs|' ${srcdir}/${pkgname}/src/modules/partition/gui/EraseDiskPage.cpp
  patch -p1 -i ${srcdir}/GreetingPage.diff
  patch -p1 -i ${srcdir}/CalamaresStyle.diff
  patch -p1 -i ${srcdir}/UEFI.diff
  patch -p1 -i ${srcdir}/JobQueue.diff
}

build() {
  mkdir -p build
  
  cd build
  
  cmake ../${pkgname} \
    -DCMAKE_BUILD_TYPE=Debug \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DWITH_PARTITIONMANAGER=1 \
    -DCMAKE_INSTALL_LIBDIR=lib 
  make
}

package() {
  cd build 
  make DESTDIR="${pkgdir}" install
  
  rm -rf "${pkgdir}/usr/share/calamares/settings.conf"
  install -D -m644 "${srcdir}/settings.conf" "${pkgdir}/usr/share/calamares/settings.conf"
  #install -D -m644 "${srcdir}/displaymanager.conf" "${pkgdir}/etc/calamares/modules/displaymanager.conf"
  install -D -m644 "${srcdir}/locale.conf" "${pkgdir}/etc/calamares/modules/locale.conf"
  install -D -m644 "${srcdir}/prepare.conf" "${pkgdir}/etc/calamares/modules/prepare.conf"
  install -D -m644 "${srcdir}/mount.conf" "${pkgdir}/etc/calamares/modules/mount.conf"
  
  sed 's|linux312|linux|' -i "${pkgdir}/usr/share/calamares/modules/initcpio.conf"
  # toggle for kf5/kde 4 ISO
  #sed 's|KaOS-kf5|KaOS|' -i "${pkgdir}/usr/share/calamares/modules/bootloader.conf"
  
  install -Dm755 "${srcdir}/launch-calamares.sh" "${pkgdir}/usr/bin/launch-calamares.sh"
  #install -Dm644 "$srcdir/$pkgname.desktop" "$pkgdir/usr/share/applications/$pkgname.desktop"
  #install -Dm644 "${srcdir}/installer.svg" "${pkgdir}/usr/share/pixmaps/installer.svg"
}
