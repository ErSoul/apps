diff -Naur libreoffice-6.0.2.1/config_host/config_gtk3_kde5.h.in libreoffice-6.0.2.1-p/config_host/config_gtk3_kde5.h.in
--- libreoffice-6.0.2.1/config_host/config_gtk3_kde5.h.in	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/config_host/config_gtk3_kde5.h.in	2018-03-02 13:47:33.371352471 +0100
@@ -0,0 +1,10 @@
+/*
+Settings for GTK3/KDE5 integration.
+*/
+
+#ifndef CONFIG_GTK3_KDE5_H
+#define CONFIG_GTK3_KDE5_H
+
+#define ENABLE_GTK3_KDE5 0
+
+#endif
diff -Naur libreoffice-6.0.2.1/config_host/config_kde5.h.in libreoffice-6.0.2.1-p/config_host/config_kde5.h.in
--- libreoffice-6.0.2.1/config_host/config_kde5.h.in	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/config_host/config_kde5.h.in	2018-03-02 13:47:33.367352462 +0100
@@ -0,0 +1,10 @@
+/*
+Settings for KDE5 integration.
+*/
+
+#ifndef CONFIG_KDE5_H
+#define CONFIG_KDE5_H
+
+#define KDE5_HAVE_GLIB 0
+
+#endif
diff -Naur libreoffice-6.0.2.1/config_host/config_vclplug.h.in libreoffice-6.0.2.1-p/config_host/config_vclplug.h.in
--- libreoffice-6.0.2.1/config_host/config_vclplug.h.in	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/config_host/config_vclplug.h.in	2018-03-02 13:47:33.371352471 +0100
@@ -9,5 +9,7 @@
 
 #define ENABLE_GTK 0
 #define ENABLE_KDE4 0
+#define ENABLE_KDE5 0
+#define ENABLE_GTK3_KDE5 0
 
 #endif
diff -Naur libreoffice-6.0.2.1/config_host.mk.in libreoffice-6.0.2.1-p/config_host.mk.in
--- libreoffice-6.0.2.1/config_host.mk.in	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/config_host.mk.in	2018-03-02 13:47:33.371352471 +0100
@@ -154,6 +154,8 @@
 export ENABLE_PDFIMPORT=@ENABLE_PDFIMPORT@
 export ENABLE_PDFIUM=@ENABLE_PDFIUM@
 export ENABLE_QT5=@ENABLE_QT5@
+export ENABLE_KDE5=@ENABLE_KDE5@
+export ENABLE_GTK3_KDE5=@ENABLE_GTK3_KDE5@
 export ENABLE_RANDR=@ENABLE_RANDR@
 export ENABLE_RELEASE_BUILD=@ENABLE_RELEASE_BUILD@
 export ENABLE_REPORTBUILDER=@ENABLE_REPORTBUILDER@
@@ -295,6 +297,9 @@
 export KDE4_HAVE_GLIB=@KDE4_HAVE_GLIB@
 export KF5_CFLAGS=$(gb_SPACE)@KF5_CFLAGS@
 export KF5_LIBS=$(gb_SPACE)@KF5_LIBS@
+export QT5_GLIB_CFLAGS=$(gb_SPACE)@QT55_GLIB_CFLAGS@
+export QT5_GLIB_LIBS=$(gb_SPACE)@QT5_GLIB_LIBS@
+export QT5_HAVE_GLIB=@QT5_HAVE_GLIB@
 export KRB5_LIBS=@KRB5_LIBS@
 export LCMS2_CFLAGS=$(gb_SPACE)@LCMS2_CFLAGS@
 export LCMS2_LIBS=$(gb_SPACE)@LCMS2_LIBS@
diff -Naur libreoffice-6.0.2.1/configure.ac libreoffice-6.0.2.1-p/configure.ac
--- libreoffice-6.0.2.1/configure.ac	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/configure.ac	2018-03-02 13:47:33.408352558 +0100
@@ -578,7 +578,9 @@
     build_gstreamer_1_0=yes
     build_gstreamer_0_10=yes
     test_kde4=yes
+    test_kde5=yes
     test_qt5=yes
+    test_gtk3_kde5=yes
     if test "$enable_fuzzers" != yes; then
         test_freetype=yes
         test_fontconfig=yes
@@ -672,7 +674,9 @@
     build_gstreamer_1_0=yes
     build_gstreamer_0_10=yes
     test_kde4=yes
+    test_kde5=yes
     test_qt5=yes
+    test_gtk3_kde5=yes
     test_freetype=yes
     AC_MSG_CHECKING([the FreeBSD operating system release])
     if test -n "$with_os_version"; then
@@ -701,7 +705,9 @@
     build_gstreamer_1_0=yes
     build_gstreamer_0_10=yes
     test_kde4=yes
+    test_kde5=yes
     test_qt5=yes
+    test_gtk3_kde5=yes
     test_freetype=yes
     PTHREAD_LIBS="-pthread -lpthread"
     _os=NetBSD
@@ -727,7 +733,9 @@
     build_gstreamer_1_0=yes
     build_gstreamer_0_10=yes
     test_kde4=yes
+    test_kde5=yes
     test_qt5=yes
+    test_gtk3_kde5=yes
     test_freetype=yes
     PTHREAD_LIBS="-pthread"
     _os=DragonFly
@@ -751,7 +759,9 @@
     test_freetype=no
     test_gtk=no
     test_kde4=no
+    test_kde5=no
     test_qt5=no
+    test_gtk3_kde5=no
     test_randr=no
     test_xrender=no
     _os=Android
@@ -1195,6 +1205,18 @@
          available.]),
 ,)
 
+AC_ARG_ENABLE(kde5,
+    AS_HELP_STRING([--enable-kde5],
+        [Determines whether to use Qt5/KF5 vclplug on platforms where Qt5 and
+         KF5 are available.]),
+,)
+
+AC_ARG_ENABLE(gtk3_kde5,
+    AS_HELP_STRING([--enable-gtk3-kde5],
+        [Determines whether to use Gtk3 vclplug with KDE file dialogs on
+         platforms where Gtk3, Qt5 and Plasma is available.]),
+,)
+
 libo_FUZZ_ARG_ENABLE(gui,
     AS_HELP_STRING([--disable-gui],
         [Disable use of X11 or Wayland to reduce dependencies. Not related to the --headless
@@ -4517,7 +4539,9 @@
     build_gstreamer_1_0=no
     build_gstreamer_0_10=no
     test_kde4=no
+    test_kde5=no
     test_qt5=no
+    test_gtk3_kde5=no
     enable_cairo_canvas=no
 fi
 
@@ -9745,6 +9769,22 @@
 fi
 AC_SUBST(ENABLE_QT5)
 
+ENABLE_KDE5=""
+if test "x$enable_kde5" = "xyes"; then
+    ENABLE_KDE5="TRUE"
+    AC_DEFINE(ENABLE_KDE5)
+    R="$R kde5"
+fi
+AC_SUBST(ENABLE_KDE5)
+
+ENABLE_GTK3_KDE5=""
+if test "x$enable_gtk3_kde5" = "xyes"; then
+    ENABLE_GTK3_KDE5="TRUE"
+    AC_DEFINE(ENABLE_GTK3_KDE5)
+    R="$R gtk3_kde5"
+fi
+AC_SUBST(ENABLE_GTK3_KDE5)
+
 build_vcl_plugins="$R"
 if test -z "$build_vcl_plugins"; then
     build_vcl_plugins="none"
@@ -10751,7 +10791,8 @@
 QT5_GLIB_LIBS=""
 QT5_HAVE_GLIB=""
 if test \( "$test_kde5" = "yes" -a "$ENABLE_KDE5" = "TRUE" \) -o \
-        \( "$test_qt5" = "yes" -a "$ENABLE_QT5" = "TRUE" \)
+        \( "$test_qt5" = "yes" -a "$ENABLE_QT5" = "TRUE" \) -o \
+        \( "$test_gtk3_kde5" = "yes" -a "$ENABLE_GTK3_KDE5" = "TRUE" \)
 then
     qt5_incdirs="$QT5INC /usr/include/qt5 /usr/include $x_includes"
     qt5_libdirs="$QT5LIB /usr/lib/qt5 /usr/lib $x_libraries"
@@ -10820,97 +10861,6 @@
         [
             QT5_HAVE_GLIB=1
             AC_DEFINE(QT5_HAVE_GLIB,1)
-            QT5_GLIB_CFLAGS=$(printf '%s' "$QT5_GLIB_CFLAGS" | sed -e "s/-I/${ISYSTEM?}/g")
-            FilterLibs "${QT5_GLIB_LIBS}"
-            QT5_GLIB_LIBS="${filteredlibs}"
-
-            qt5_fix_warning=
-
-            AC_LANG_PUSH([C++])
-            # tst_exclude_socket_notifiers.moc:70:28: runtime error: member access within address 0x60d00000bb20 which does not point to an object of type 'QO
-            # 0x60d00000bb20: note: object is of type 'QObjectPrivate'
-            #  02 00 80 3a  90 8a 4e d2 3a 00 00 00  f0 b4 b9 a7 ff 7f 00 00  00 00 00 00 00 00 00 00  20 d8 4e d2
-            #               ^~~~~~~~~~~~~~~~~~~~~~~
-            #               vptr for 'QObjectPrivate'
-            save_CXX=$CXX
-            CXX=$(printf %s "$CXX" \
-                | sed -e 's/-fno-sanitize-recover\(=[[0-9A-Za-z,_-]]*\)*//')
-            save_CXXFLAGS=$CXXFLAGS
-            CXXFLAGS="$CXXFLAGS $QT5_CFLAGS"
-            save_LIBS=$LIBS
-            LIBS="$LIBS $QT5_LIBS"
-            AC_MSG_CHECKING([whether Qt has fixed ExcludeSocketNotifiers])
-            # Prepare meta object data
-            TSTBASE="tst_exclude_socket_notifiers"
-            TSTMOC="${SRC_ROOT}/vcl/unx/qt5/${TSTBASE}"
-            ln -fs "${TSTMOC}.hxx"
-            $MOC5 "${TSTBASE}.hxx" -o "${TSTBASE}.moc"
-
-            AC_RUN_IFELSE([AC_LANG_SOURCE([[
-#include <cstdlib>
-#include "tst_exclude_socket_notifiers.moc"
-
-int main(int argc, char *argv[])
-{
-    QCoreApplication app(argc, argv);
-    exit(tst_processEventsExcludeSocket());
-    return 0;
-}
-            ]])],[
-                AC_MSG_RESULT([yes])
-            ],[
-                AC_MSG_RESULT([no])
-                AC_MSG_WARN([native Qt5 file pickers will be disabled at runtime])
-                if test -z "$qt5_fix_warning"; then
-                    add_warning "native QT5 file pickers will be disabled at runtime, Qt5 fixes needed"
-                fi
-                qt5_fix_warning=1
-                add_warning "  https://bugreports.qt-project.org/browse/QTBUG-37380 (needed)"
-            ])
-
-            # Remove meta object data
-            rm -f "${TSTBASE}."*
-
-            AC_MSG_CHECKING([whether Qt avoids QClipboard recursion caused by posted events])
-            # Prepare meta object data
-            TSTBASE="tst_exclude_posted_events"
-            TSTMOC="${SRC_ROOT}/vcl/unx/qt5/${TSTBASE}"
-            ln -fs "${TSTMOC}.hxx"
-            $MOC5 "${TSTBASE}.hxx" -o "${TSTBASE}.moc"
-
-            AC_RUN_IFELSE([AC_LANG_SOURCE([[
-#include <cstdlib>
-#include "tst_exclude_posted_events.moc"
-
-int main(int argc, char *argv[])
-{
-    QCoreApplication app(argc, argv);
-    exit(tst_excludePostedEvents());
-    return 0;
-}
-            ]])],[
-                AC_MSG_RESULT([yes])
-            ],[
-                AC_MSG_RESULT([no])
-                AC_MSG_WARN([native QT5 file pickers will be disabled at runtime])
-                if test -z "$qt5_fix_warning"; then
-                    add_warning "native QT5 file pickers will be disabled at runtime, Qt5 fixes needed"
-                fi
-                qt5_fix_warning=1
-                add_warning "  https://bugreports.qt-project.org/browse/QTBUG-34614 (needed)"
-            ])
-
-            # Remove meta object data
-            rm -f "${TSTBASE}."*
-
-            if test -n "$qt5_fix_warning"; then
-                add_warning "  https://bugreports.qt-project.org/browse/QTBUG-38585 (recommended)"
-            fi
-
-            LIBS=$save_LIBS
-            CXXFLAGS=$save_CXXFLAGS
-            CXX=$save_CXX
-            AC_LANG_POP([C++])
         ],
         AC_MSG_WARN([[No Glib found, Qt5 support will not use native file pickers!]])
     )
@@ -10930,15 +10880,16 @@
 KF5_LIBS=""
 KF5_CONFIG="kf5-config"
 if test \( "$test_kde5" = "yes" -a "$ENABLE_KDE5" = "TRUE" \) -o \
-        \( "$test_kf5" = "yes" -a "$ENABLE_KF5" = "TRUE" \)
+        \( "$test_kf5" = "yes" -a "$ENABLE_KF5" = "TRUE" \) -o \
+        \( "$test_gtk3_kde5" = "yes" -a "$ENABLE_GTK3_KDE5" = "TRUE" \)
 then
-    kf5_incdirs="$KF5INC /usr/include /usr/include/KF5 $x_includes"
+    kf5_incdirs="$KF5INC /usr/include/ $x_includes"
     kf5_libdirs="$KF5LIB /usr/lib /usr/lib/kf5 /usr/lib/kf5/devel $x_libraries"
     if test -n "$supports_multilib"; then
         kf5_libdirs="$kf5_libdirs /usr/lib64 /usr/lib64/kf5 /usr/lib64/kf5/devel"
     fi
 
-    kf5_test_include="kcoreaddons_version.h"
+    kf5_test_include="KF5/kcoreaddons_version.h"
     kf5_test_library="libKF5CoreAddons.so"
     kf5_libdirs="$qt5_libdir $kf5_libdirs"
 
@@ -10954,7 +10905,7 @@
     kf5_incdir="no"
     for kf5_check in $kf5_incdirs; do
         if test -r "$kf5_check/$kf5_test_include"; then
-            kf5_incdir="$kf5_check"
+            kf5_incdir="$kf5_check/KF5"
             break
         fi
     done
@@ -10980,8 +10931,8 @@
 
     PKG_CHECK_MODULES(KF5_XCB,[xcb],,[AC_MSG_ERROR([XCB not installed])])
 
-    KF5_CFLAGS="-I$kf5_incdir -I$kf5_incdir/KCoreAddons -I$kf5_incdir/KI18n -I$kf5_incdir/KConfigCore -I$kf5_incdir/KWindowSystem -I$kf5_incdir/KIOCore -I$qt5_incdir -I$qt5_incdir/QtCore -I$qt5_incdir/QtGui -I$qt5_incdir/QtWidgets -I$qt5_incdir/QtNetwork -DQT_CLEAN_NAMESPACE -DQT_THREAD_SUPPORT $KF5_XCB_CFLAGS"
-    KF5_LIBS="-L$kf5_libdir -lKF5CoreAddons -lKF5I18n -lKF5ConfigCore -lKF5WindowSystem -lKF5KIOCore -L$qt5_libdir -lQt5Core -lQt5Gui -lQt5Widgets -lQt5Network -lQt5X11Extras $KF5_XCB_LIBS"
+    KF5_CFLAGS="-I$kf5_incdir -I$kf5_incdir/KCoreAddons -I$kf5_incdir/KI18n -I$kf5_incdir/KConfigCore -I$kf5_incdir/KWindowSystem -I$kf5_incdir/KIOCore -I$kf5_incdir/KIOWidgets -I$kf5_incdir/KIOFileWidgets -I$qt5_incdir -I$qt5_incdir/QtCore -I$qt5_incdir/QtGui -I$qt5_incdir/QtWidgets -I$qt5_incdir/QtNetwork -DQT_CLEAN_NAMESPACE -DQT_THREAD_SUPPORT $KF5_XCB_CFLAGS"
+    KF5_LIBS="-L$kf5_libdir -lKF5CoreAddons -lKF5I18n -lKF5ConfigCore -lKF5WindowSystem -lKF5KIOCore -lKF5KIOWidgets -lKF5KIOFileWidgets -L$qt5_libdir -lQt5Core -lQt5Gui -lQt5Widgets -lQt5Network -lQt5X11Extras $KF5_XCB_LIBS"
     KF5_CFLAGS=$(printf '%s' "$KF5_CFLAGS" | sed -e "s/-I/${ISYSTEM?}/g")
 
     AC_LANG_PUSH([C++])
@@ -12546,6 +12497,8 @@
 AC_CONFIG_HEADERS([config_host/config_mpl.h])
 AC_CONFIG_HEADERS([config_host/config_kde4.h])
 AC_CONFIG_HEADERS([config_host/config_qt5.h])
+AC_CONFIG_HEADERS([config_host/config_kde5.h])
+AC_CONFIG_HEADERS([config_host/config_gtk3_kde5.h])
 AC_CONFIG_HEADERS([config_host/config_oox.h])
 AC_CONFIG_HEADERS([config_host/config_options.h])
 AC_CONFIG_HEADERS([config_host/config_options_calc.h])
diff -Naur libreoffice-6.0.2.1/postprocess/Rdb_services.mk libreoffice-6.0.2.1-p/postprocess/Rdb_services.mk
--- libreoffice-6.0.2.1/postprocess/Rdb_services.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/postprocess/Rdb_services.mk	2018-03-02 13:47:33.364352455 +0100
@@ -213,6 +213,9 @@
 	$(if $(ENABLE_KDE4), \
 		shell/source/backends/kde4be/kde4be1 \
 	) \
+	$(if $(ENABLE_KDE5), \
+		shell/source/backends/kde5be/kde5be1 \
+	) \
 	$(if $(ENABLE_ONLINE_UPDATE), \
 		extensions/source/update/check/updchk.uno \
 		extensions/source/update/ui/updchk \
diff -Naur libreoffice-6.0.2.1/RepositoryExternal.mk libreoffice-6.0.2.1-p/RepositoryExternal.mk
--- libreoffice-6.0.2.1/RepositoryExternal.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/RepositoryExternal.mk	2018-03-02 13:47:33.366352460 +0100
@@ -3066,6 +3066,41 @@
 
 endif # ENABLE_KDE4
 
+
+ifeq ($(ENABLE_KDE5),TRUE)
+
+define gb_LinkTarget__use_kde5
+$(call gb_LinkTarget_set_include,$(1),\
+	$(KF5_CFLAGS) \
+	$$(INCLUDE) \
+)
+
+$(call gb_LinkTarget_add_defs,$(1),\
+	$(KF5_CFLAGS) \
+)
+
+$(call gb_LinkTarget_add_libs,$(1),\
+	$(KF5_LIBS) \
+)
+
+ifeq ($(COM),GCC)
+$(call gb_LinkTarget_add_cxxflags,$(1),\
+	-Wno-shadow \
+)
+endif
+
+endef
+
+else # !ENABLE_KDE5
+
+define gb_LinkTarget__use_kde5
+
+endef
+
+endif # ENABLE_KDE5
+
+
+
 ifeq ($(ENABLE_QT5),TRUE)
 
 define gb_LinkTarget__use_qt5
diff -Naur libreoffice-6.0.2.1/Repository.mk libreoffice-6.0.2.1-p/Repository.mk
--- libreoffice-6.0.2.1/Repository.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/Repository.mk	2018-03-02 13:47:33.371352471 +0100
@@ -291,11 +291,19 @@
 
 $(eval $(call gb_Helper_register_libraries_for_install,OOOLIBS,kde, \
 	$(if $(ENABLE_KDE4),kde4be1) \
+	$(if $(ENABLE_KDE5),kde5be1) \
 	$(if $(USING_X11), \
 		$(if $(ENABLE_KDE4),vclplug_kde4) \
+		$(if $(ENABLE_KDE5),vclplug_kde5) \
         $(if $(ENABLE_QT5),vclplug_qt5) \
+		$(if $(ENABLE_GTK3_KDE5),vclplug_gtk3_kde5) \
 	) \
 ))
+ifneq ($(ENABLE_GTK3_KDE5),)
+$(eval $(call gb_Helper_register_executables_for_install,OOO,kde, \
+	lo_kde5filepicker \
+))
+endif
 
 $(eval $(call gb_Helper_register_libraries_for_install,OOOLIBS,math, \
 	sm \
diff -Naur libreoffice-6.0.2.1/scp2/InstallScript_setup_osl.mk libreoffice-6.0.2.1-p/scp2/InstallScript_setup_osl.mk
--- libreoffice-6.0.2.1/scp2/InstallScript_setup_osl.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/scp2/InstallScript_setup_osl.mk	2018-03-02 13:47:33.369352467 +0100
@@ -35,7 +35,7 @@
 	$(if $(filter TRUE,$(ENABLE_EVOAB2) $(ENABLE_GIO) $(ENABLE_GTK) $(ENABLE_GTK3)),\
 		scp2/gnome \
 	) \
-	$(if $(filter TRUE,$(ENABLE_KDE4) $(ENABLE_QT5)),\
+	$(if $(filter TRUE,$(ENABLE_KDE4) $(ENABLE_QT5) $(ENABLE_KDE5)),\
 		scp2/kde \
 	) \
 	$(if $(filter TRUE,$(ENABLE_ONLINE_UPDATE)),\
diff -Naur libreoffice-6.0.2.1/scp2/Module_scp2.mk libreoffice-6.0.2.1-p/scp2/Module_scp2.mk
--- libreoffice-6.0.2.1/scp2/Module_scp2.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/scp2/Module_scp2.mk	2018-03-02 13:47:33.369352467 +0100
@@ -39,7 +39,7 @@
 	$(if $(filter TRUE,$(ENABLE_EVOAB2) $(ENABLE_GIO) $(ENABLE_GTK) $(ENABLE_GTK3)),\
 		InstallModule_gnome \
 	) \
-	$(if $(filter TRUE,$(ENABLE_KDE4) $(ENABLE_QT5)),\
+	$(if $(filter TRUE,$(ENABLE_KDE4) $(ENABLE_QT5) $(ENABLE_KDE5)),\
 		InstallModule_kde \
 	) \
 ))
diff -Naur libreoffice-6.0.2.1/shell/Library_kde5be.mk libreoffice-6.0.2.1-p/shell/Library_kde5be.mk
--- libreoffice-6.0.2.1/shell/Library_kde5be.mk	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/Library_kde5be.mk	2018-03-02 13:47:33.364352455 +0100
@@ -0,0 +1,32 @@
+# -*- Mode: makefile-gmake; tab-width: 4; indent-tabs-mode: t -*-
+#
+# This file is part of the LibreOffice project.
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+$(eval $(call gb_Library_Library,kde5be1))
+
+$(eval $(call gb_Library_use_sdk_api,kde5be1))
+
+$(eval $(call gb_Library_use_externals,kde5be1,\
+	boost_headers \
+	kde5 \
+))
+
+$(eval $(call gb_Library_use_libraries,kde5be1,\
+	cppu \
+	cppuhelper \
+	sal \
+))
+
+$(eval $(call gb_Library_set_componentfile,kde5be1,shell/source/backends/kde5be/kde5be1))
+
+$(eval $(call gb_Library_add_exception_objects,kde5be1,\
+    shell/source/backends/kde5be/kde5access \
+    shell/source/backends/kde5be/kde5backend \
+))
+
+# vim: set shiftwidth=4 tabstop=4 noexpandtab:
diff -Naur libreoffice-6.0.2.1/shell/Module_shell.mk libreoffice-6.0.2.1-p/shell/Module_shell.mk
--- libreoffice-6.0.2.1/shell/Module_shell.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/Module_shell.mk	2018-03-02 13:47:33.364352455 +0100
@@ -36,6 +36,12 @@
 ))
 endif
 
+ifeq ($(ENABLE_KDE5),TRUE)
+$(eval $(call gb_Module_add_targets,shell,\
+	Library_kde5be \
+))
+endif
+
 ifeq ($(OS),WNT)
 
 $(eval $(call gb_Module_add_targets,shell,\
diff -Naur libreoffice-6.0.2.1/shell/source/backends/desktopbe/desktopbackend.cxx libreoffice-6.0.2.1-p/shell/source/backends/desktopbe/desktopbackend.cxx
--- libreoffice-6.0.2.1/shell/source/backends/desktopbe/desktopbackend.cxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/source/backends/desktopbe/desktopbackend.cxx	2018-03-02 13:47:33.364352455 +0100
@@ -307,6 +307,10 @@
         backend = createBackend(
             context,
             "com.sun.star.configuration.backend.KDE4Backend");
+    } else if ( desktop == "KDE5" ) {
+        backend = createBackend(
+            context,
+            "com.sun.star.configuration.backend.KDE5Backend");
     }
     return backend.is()
         ? backend : static_cast< cppu::OWeakObject * >(new Default);
diff -Naur libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5access.cxx libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5access.cxx
--- libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5access.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5access.cxx	2018-03-02 13:47:33.400352539 +0100
@@ -0,0 +1,316 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include <sal/config.h>
+
+#include "kde5access.hxx"
+
+#include <QtGui/QFont>
+#include <QtCore/QString>
+#include <QtGui/QFontDatabase>
+#include <QtCore/QStandardPaths>
+#include <QtCore/QDir>
+#include <QtCore/QUrl>
+
+#include <kprotocolmanager.h>
+
+#include <kemailsettings.h>
+// #include <kglobalsettings.h>
+
+#include <com/sun/star/uno/Any.hxx>
+#include <cppu/unotype.hxx>
+#include <osl/diagnose.h>
+#include <osl/file.h>
+#include <rtl/string.h>
+#include <rtl/ustring.hxx>
+
+namespace kde5access
+{
+namespace
+{
+namespace uno = css::uno;
+}
+
+css::beans::Optional<css::uno::Any> getValue(OUString const& id)
+{
+    if (id == "ExternalMailer")
+    {
+        KEMailSettings aEmailSettings;
+        QString aClientProgram;
+        OUString sClientProgram;
+
+        aClientProgram = aEmailSettings.getSetting(KEMailSettings::ClientProgram);
+        if (aClientProgram.isEmpty())
+            aClientProgram = QStringLiteral("kmail");
+        else
+            aClientProgram = aClientProgram.section(QLatin1Char(' '), 0, 0);
+        sClientProgram = reinterpret_cast<const sal_Unicode*>(aClientProgram.utf16());
+        return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sClientProgram));
+    }
+    else if (id == "SourceViewFontHeight")
+    {
+        const QFont aFixedFont = QFontDatabase::systemFont(QFontDatabase::FixedFont);
+        const short nFontHeight = aFixedFont.pointSize();
+        return css::beans::Optional<css::uno::Any>(true, uno::makeAny(nFontHeight));
+    }
+    else if (id == "SourceViewFontName")
+    {
+        const QFont aFixedFont = QFontDatabase::systemFont(QFontDatabase::FixedFont);
+        const QString aFontName = aFixedFont.family();
+        const OUString sFontName = reinterpret_cast<const sal_Unicode*>(aFontName.utf16());
+        return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sFontName));
+    }
+    else if (id == "EnableATToolSupport")
+    {
+        /* does not make much sense without an accessibility bridge */
+        bool ATToolSupport = false;
+        return css::beans::Optional<css::uno::Any>(true,
+                                                   uno::makeAny(OUString::boolean(ATToolSupport)));
+    }
+    else if (id == "WorkPathVariable")
+    {
+        QString aDocumentsDir(QStandardPaths::writableLocation(QStandardPaths::DocumentsLocation));
+        if (aDocumentsDir.isEmpty())
+            aDocumentsDir = QDir::homePath();
+        OUString sDocumentsDir;
+        OUString sDocumentsURL;
+        if (aDocumentsDir.endsWith(QLatin1Char('/')))
+            aDocumentsDir.truncate(aDocumentsDir.length() - 1);
+        sDocumentsDir = reinterpret_cast<const sal_Unicode*>(aDocumentsDir.utf16());
+        osl_getFileURLFromSystemPath(sDocumentsDir.pData, &sDocumentsURL.pData);
+        return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sDocumentsURL));
+    }
+    else if (id == "ooInetFTPProxyName")
+    {
+        QString aFTPProxy;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+                aFTPProxy = KProtocolManager::proxyFor(QStringLiteral("FTP"));
+                break;
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                // In such cases, the proxy address is not stored in KDE, but determined dynamically.
+                // The proxy address may depend on the requested address, on the time of the day, on the speed of the wind...
+                // The best we can do here is to ask the current value for a given address.
+                aFTPProxy = KProtocolManager::proxyForUrl(
+                    QUrl(QStringLiteral("ftp://ftp.libreoffice.org")));
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aFTPProxy.isEmpty())
+        {
+            QUrl aProxy(aFTPProxy);
+            OUString sProxy = reinterpret_cast<const sal_Unicode*>(aProxy.host().utf16());
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sProxy));
+        }
+    }
+    else if (id == "ooInetFTPProxyPort")
+    {
+        QString aFTPProxy;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+                aFTPProxy = KProtocolManager::proxyFor(QStringLiteral("FTP"));
+                break;
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                // In such cases, the proxy address is not stored in KDE, but determined dynamically.
+                // The proxy address may depend on the requested address, on the time of the day, on the speed of the wind...
+                // The best we can do here is to ask the current value for a given address.
+                aFTPProxy = KProtocolManager::proxyForUrl(
+                    QUrl(QStringLiteral("ftp://ftp.libreoffice.org")));
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aFTPProxy.isEmpty())
+        {
+            QUrl aProxy(aFTPProxy);
+            sal_Int32 nPort = aProxy.port();
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(nPort));
+        }
+    }
+    else if (id == "ooInetHTTPProxyName")
+    {
+        QString aHTTPProxy;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+                aHTTPProxy = KProtocolManager::proxyFor(QStringLiteral("HTTP"));
+                break;
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                // In such cases, the proxy address is not stored in KDE, but determined dynamically.
+                // The proxy address may depend on the requested address, on the time of the day, on the speed of the wind...
+                // The best we can do here is to ask the current value for a given address.
+                aHTTPProxy = KProtocolManager::proxyForUrl(
+                    QUrl(QStringLiteral("ftp://ftp.libreoffice.org")));
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aHTTPProxy.isEmpty())
+        {
+            QUrl aProxy(aHTTPProxy);
+            OUString sProxy = reinterpret_cast<const sal_Unicode*>(aProxy.host().utf16());
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sProxy));
+        }
+    }
+    else if (id == "ooInetHTTPProxyPort")
+    {
+        QString aHTTPProxy;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+                aHTTPProxy = KProtocolManager::proxyFor(QStringLiteral("HTTP"));
+                break;
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                // In such cases, the proxy address is not stored in KDE, but determined dynamically.
+                // The proxy address may depend on the requested address, on the time of the day, on the speed of the wind...
+                // The best we can do here is to ask the current value for a given address.
+                aHTTPProxy = KProtocolManager::proxyForUrl(
+                    QUrl(QStringLiteral("ftp://ftp.libreoffice.org")));
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aHTTPProxy.isEmpty())
+        {
+            QUrl aProxy(aHTTPProxy);
+            sal_Int32 nPort = aProxy.port();
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(nPort));
+        }
+    }
+    else if (id == "ooInetHTTPSProxyName")
+    {
+        QString aHTTPSProxy;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+                aHTTPSProxy = KProtocolManager::proxyFor(QStringLiteral("HTTPS"));
+                break;
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                // In such cases, the proxy address is not stored in KDE, but determined dynamically.
+                // The proxy address may depend on the requested address, on the time of the day, on the speed of the wind...
+                // The best we can do here is to ask the current value for a given address.
+                aHTTPSProxy = KProtocolManager::proxyForUrl(
+                    QUrl(QStringLiteral("ftp://ftp.libreoffice.org")));
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aHTTPSProxy.isEmpty())
+        {
+            QUrl aProxy(aHTTPSProxy);
+            OUString sProxy = reinterpret_cast<const sal_Unicode*>(aProxy.host().utf16());
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sProxy));
+        }
+    }
+    else if (id == "ooInetHTTPSProxyPort")
+    {
+        QString aHTTPSProxy;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+                aHTTPSProxy = KProtocolManager::proxyFor(QStringLiteral("HTTPS"));
+                break;
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                // In such cases, the proxy address is not stored in KDE, but determined dynamically.
+                // The proxy address may depend on the requested address, on the time of the day, on the speed of the wind...
+                // The best we can do here is to ask the current value for a given address.
+                aHTTPSProxy = KProtocolManager::proxyForUrl(
+                    QUrl(QStringLiteral("ftp://ftp.libreoffice.org")));
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aHTTPSProxy.isEmpty())
+        {
+            QUrl aProxy(aHTTPSProxy);
+            sal_Int32 nPort = aProxy.port();
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(nPort));
+        }
+    }
+    else if (id == "ooInetNoProxy")
+    {
+        QString aNoProxyFor;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                aNoProxyFor = KProtocolManager::noProxyFor();
+                break;
+            default: // No proxy is used
+                break;
+        }
+        if (!aNoProxyFor.isEmpty())
+        {
+            OUString sNoProxyFor;
+
+            aNoProxyFor = aNoProxyFor.replace(QLatin1Char(','), QLatin1Char(';'));
+            sNoProxyFor = reinterpret_cast<const sal_Unicode*>(aNoProxyFor.utf16());
+            return css::beans::Optional<css::uno::Any>(true, uno::makeAny(sNoProxyFor));
+        }
+    }
+    else if (id == "ooInetProxyType")
+    {
+        sal_Int32 nProxyType;
+        switch (KProtocolManager::proxyType())
+        {
+            case KProtocolManager::ManualProxy: // Proxies are manually configured
+            case KProtocolManager::PACProxy: // A proxy configuration URL has been given
+            case KProtocolManager::WPADProxy: // A proxy should be automatically discovered
+            case KProtocolManager::
+                EnvVarProxy: // Use the proxy values set through environment variables
+                nProxyType = 1;
+                break;
+            default: // No proxy is used
+                nProxyType = 0;
+        }
+        return css::beans::Optional<css::uno::Any>(true, uno::makeAny(nProxyType));
+    }
+    else
+    {
+        OSL_ASSERT(false); // this cannot happen
+    }
+    return css::beans::Optional<css::uno::Any>();
+}
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5access.hxx libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5access.hxx
--- libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5access.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5access.hxx	2018-03-02 13:47:33.364352455 +0100
@@ -0,0 +1,48 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#ifndef INCLUDED_SHELL_SOURCE_BACKENDS_KDE5BE_KDE5ACCESS_HXX
+#define INCLUDED_SHELL_SOURCE_BACKENDS_KDE5BE_KDE5ACCESS_HXX
+
+#include <sal/config.h>
+
+#include <com/sun/star/beans/Optional.hpp>
+
+namespace com
+{
+namespace sun
+{
+namespace star
+{
+namespace uno
+{
+class Any;
+}
+}
+}
+}
+
+namespace kde5access
+{
+css::beans::Optional<css::uno::Any> getValue(OUString const& id);
+}
+
+#endif
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5backend.cxx libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5backend.cxx
--- libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5backend.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5backend.cxx	2018-03-02 13:47:33.400352539 +0100
@@ -0,0 +1,251 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include <sal/config.h>
+
+#include <QtWidgets/QApplication>
+
+#include <boost/noncopyable.hpp>
+#include <com/sun/star/beans/Optional.hpp>
+#include <com/sun/star/beans/PropertyVetoException.hpp>
+#include <com/sun/star/beans/UnknownPropertyException.hpp>
+#include <com/sun/star/beans/XPropertyChangeListener.hpp>
+#include <com/sun/star/beans/XPropertySet.hpp>
+#include <com/sun/star/beans/XPropertySetInfo.hpp>
+#include <com/sun/star/beans/XVetoableChangeListener.hpp>
+#include <com/sun/star/lang/IllegalArgumentException.hpp>
+#include <com/sun/star/lang/WrappedTargetException.hpp>
+#include <com/sun/star/lang/XMultiComponentFactory.hpp>
+#include <com/sun/star/lang/XServiceInfo.hpp>
+#include <com/sun/star/uno/Any.hxx>
+#include <com/sun/star/uno/Reference.hxx>
+#include <com/sun/star/uno/RuntimeException.hpp>
+#include <com/sun/star/uno/Sequence.hxx>
+#include <com/sun/star/uno/XComponentContext.hpp>
+#include <com/sun/star/uno/XCurrentContext.hpp>
+#include <cppuhelper/factory.hxx>
+#include <cppuhelper/implbase.hxx>
+#include <cppuhelper/implementationentry.hxx>
+#include <cppuhelper/weak.hxx>
+#include <rtl/string.h>
+#include <rtl/ustring.h>
+#include <rtl/ustring.hxx>
+#include <sal/types.h>
+#include <uno/current_context.hxx>
+
+#include <osl/process.h>
+#include <osl/thread.h>
+
+#include "kde5access.hxx"
+
+namespace
+{
+OUString getServiceImplementationName()
+{
+    return OUString("com.sun.star.comp.configuration.backend.KDE5Backend");
+}
+
+css::uno::Sequence<OUString> getServiceSupportedServiceNames()
+{
+    OUString name("com.sun.star.configuration.backend.KDE5Backend");
+    return css::uno::Sequence<OUString>(&name, 1);
+}
+
+class Service : public cppu::WeakImplHelper<css::lang::XServiceInfo, css::beans::XPropertySet>,
+                private boost::noncopyable
+{
+public:
+    Service();
+
+private:
+    virtual ~Service() override {}
+
+    virtual OUString SAL_CALL getImplementationName() override
+    {
+        return getServiceImplementationName();
+    }
+
+    virtual sal_Bool SAL_CALL supportsService(OUString const& ServiceName) override
+    {
+        return ServiceName == getSupportedServiceNames()[0];
+    }
+
+    virtual css::uno::Sequence<OUString> SAL_CALL getSupportedServiceNames() override
+    {
+        return getServiceSupportedServiceNames();
+    }
+
+    virtual css::uno::Reference<css::beans::XPropertySetInfo> SAL_CALL getPropertySetInfo() override
+    {
+        return css::uno::Reference<css::beans::XPropertySetInfo>();
+    }
+
+    virtual void SAL_CALL setPropertyValue(OUString const&, css::uno::Any const&) override;
+
+    virtual css::uno::Any SAL_CALL getPropertyValue(OUString const& PropertyName) override;
+
+    virtual void SAL_CALL addPropertyChangeListener(
+        OUString const&, css::uno::Reference<css::beans::XPropertyChangeListener> const&) override
+    {
+    }
+
+    virtual void SAL_CALL removePropertyChangeListener(
+        OUString const&, css::uno::Reference<css::beans::XPropertyChangeListener> const&) override
+    {
+    }
+
+    virtual void SAL_CALL addVetoableChangeListener(
+        OUString const&, css::uno::Reference<css::beans::XVetoableChangeListener> const&) override
+    {
+    }
+
+    virtual void SAL_CALL removeVetoableChangeListener(
+        OUString const&, css::uno::Reference<css::beans::XVetoableChangeListener> const&) override
+    {
+    }
+
+    bool enabled_;
+};
+
+OString getDisplayArg()
+{
+    OUString aParam;
+    const sal_uInt32 nParams = osl_getCommandArgCount();
+    for (sal_uInt32 nIdx = 0; nIdx < nParams; ++nIdx)
+    {
+        osl_getCommandArg(nIdx, &aParam.pData);
+        if (aParam != "-display")
+            continue;
+
+        ++nIdx;
+        osl_getCommandArg(nIdx, &aParam.pData);
+        return OUStringToOString(aParam, osl_getThreadTextEncoding());
+    }
+    return {};
+}
+
+OString getExecutable()
+{
+    OUString aParam, aBin;
+    osl_getExecutableFile(&aParam.pData);
+    osl_getSystemPathFromFileURL(aParam.pData, &aBin.pData);
+    return OUStringToOString(aBin, osl_getThreadTextEncoding());
+}
+
+// init the QApplication when we load the kde5backend into a non-Qt vclplug (e.g. Gtk3KDE5)
+// TODO: use a helper process to read these values without linking to Qt directly?
+// TODO: share this code somehow with Qt5Instance.cxx?
+void initQApp()
+{
+    const auto aDisplay = getDisplayArg();
+    int nFakeArgc = aDisplay.isEmpty() ? 2 : 3;
+    char** pFakeArgv = new char*[nFakeArgc];
+
+    pFakeArgv[0] = strdup(getExecutable().getStr());
+    pFakeArgv[1] = strdup("--nocrashhandler");
+    if (aDisplay.isEmpty())
+        pFakeArgv[2] = strdup(aDisplay.getStr());
+
+    char* session_manager = nullptr;
+    if (auto* session_manager_env = getenv("SESSION_MANAGER"))
+    {
+        session_manager = strdup(session_manager_env);
+        unsetenv("SESSION_MANAGER");
+    }
+
+    auto app = new QApplication(nFakeArgc, pFakeArgv);
+    QObject::connect(app, &QObject::destroyed, app, [nFakeArgc, pFakeArgv]() {
+        for (int i = 0; i < nFakeArgc; ++i)
+            delete pFakeArgv[i];
+        delete[] pFakeArgv;
+    });
+
+    if (session_manager != nullptr)
+    {
+        // coverity[tainted_string] - trusted source for setenv
+        setenv("SESSION_MANAGER", session_manager, 1);
+        free(session_manager);
+    }
+
+    QApplication::setQuitOnLastWindowClosed(false);
+}
+
+Service::Service()
+    : enabled_(false)
+{
+    css::uno::Reference<css::uno::XCurrentContext> context(css::uno::getCurrentContext());
+    if (context.is())
+    {
+        if (!qApp)
+        {
+            initQApp();
+        }
+        OUString desktop;
+        context->getValueByName("system.desktop-environment") >>= desktop;
+        enabled_ = desktop == "KDE5" && qApp != nullptr;
+    }
+}
+
+void Service::setPropertyValue(OUString const&, css::uno::Any const&)
+{
+    throw css::lang::IllegalArgumentException("setPropertyValue not supported",
+                                              static_cast<cppu::OWeakObject*>(this), -1);
+}
+
+css::uno::Any Service::getPropertyValue(OUString const& PropertyName)
+{
+    if (PropertyName == "EnableATToolSupport" || PropertyName == "ExternalMailer"
+        || PropertyName == "SourceViewFontHeight" || PropertyName == "SourceViewFontName"
+        || PropertyName == "WorkPathVariable" || PropertyName == "ooInetFTPProxyName"
+        || PropertyName == "ooInetFTPProxyPort" || PropertyName == "ooInetHTTPProxyName"
+        || PropertyName == "ooInetHTTPProxyPort" || PropertyName == "ooInetHTTPSProxyName"
+        || PropertyName == "ooInetHTTPSProxyPort" || PropertyName == "ooInetNoProxy"
+        || PropertyName == "ooInetProxyType")
+    {
+        return css::uno::makeAny(enabled_ ? kde5access::getValue(PropertyName)
+                                          : css::beans::Optional<css::uno::Any>());
+    }
+    else if (PropertyName == "givenname" || PropertyName == "sn"
+             || PropertyName == "TemplatePathVariable")
+    {
+        return css::uno::makeAny(css::beans::Optional<css::uno::Any>());
+        //TODO: obtain values from KDE?
+    }
+    throw css::beans::UnknownPropertyException(PropertyName, static_cast<cppu::OWeakObject*>(this));
+}
+
+css::uno::Reference<css::uno::XInterface>
+createInstance(css::uno::Reference<css::uno::XComponentContext> const&)
+{
+    return static_cast<cppu::OWeakObject*>(new Service);
+}
+
+static cppu::ImplementationEntry const services[]
+    = { { &createInstance, &getServiceImplementationName, &getServiceSupportedServiceNames,
+          &cppu::createSingleComponentFactory, nullptr, 0 },
+        { nullptr, nullptr, nullptr, nullptr, nullptr, 0 } };
+}
+
+extern "C" SAL_DLLPUBLIC_EXPORT void*
+kde5be1_component_getFactory(char const* pImplName, void* pServiceManager, void* pRegistryKey)
+{
+    return cppu::component_getFactoryHelper(pImplName, pServiceManager, pRegistryKey, services);
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5be1.component libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5be1.component
--- libreoffice-6.0.2.1/shell/source/backends/kde5be/kde5be1.component	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/shell/source/backends/kde5be/kde5be1.component	2018-03-02 13:47:33.364352455 +0100
@@ -0,0 +1,25 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ -->
+
+<component loader="com.sun.star.loader.SharedLibrary" environment="@CPPU_ENV@"
+    prefix="kde5be1" xmlns="http://openoffice.org/2010/uno-components">
+  <implementation name="com.sun.star.comp.configuration.backend.KDE5Backend">
+    <service name="com.sun.star.configuration.backend.KDE5Backend"/>
+  </implementation>
+</component>
diff -Naur libreoffice-6.0.2.1/vcl/CustomTarget_gtk3_kde5_moc.mk libreoffice-6.0.2.1-p/vcl/CustomTarget_gtk3_kde5_moc.mk
--- libreoffice-6.0.2.1/vcl/CustomTarget_gtk3_kde5_moc.mk	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/CustomTarget_gtk3_kde5_moc.mk	2018-03-02 13:47:33.373352476 +0100
@@ -0,0 +1,22 @@
+# -*- Mode: makefile-gmake; tab-width: 4; indent-tabs-mode: t -*-
+#
+# This file is part of the LibreOffice project.
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+
+$(eval $(call gb_CustomTarget_CustomTarget,vcl/unx/gtk3_kde5))
+
+$(call gb_CustomTarget_get_target,vcl/unx/gtk3_kde5) : \
+	$(call gb_CustomTarget_get_workdir,vcl/unx/gtk3_kde5)/kde5_filepicker.moc \
+	$(call gb_CustomTarget_get_workdir,vcl/unx/gtk3_kde5)/kde5_filepicker_ipc.moc \
+
+$(call gb_CustomTarget_get_workdir,vcl/unx/gtk3_kde5)/%.moc : \
+		$(SRCDIR)/vcl/unx/gtk3_kde5/%.hxx \
+		| $(call gb_CustomTarget_get_workdir,vcl/unx/gtk3_kde5)/.dir
+	$(call gb_Output_announce,$(subst $(WORKDIR)/,,$@),$(true),MOC,1)
+	$(MOC5) $< -o $@
+
+# vim: set noet sw=4:
diff -Naur libreoffice-6.0.2.1/vcl/Executable_lo_kde5filepicker.mk libreoffice-6.0.2.1-p/vcl/Executable_lo_kde5filepicker.mk
--- libreoffice-6.0.2.1/vcl/Executable_lo_kde5filepicker.mk	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/Executable_lo_kde5filepicker.mk	2018-03-02 13:47:33.373352476 +0100
@@ -0,0 +1,99 @@
+# -*- Mode: makefile-gmake; tab-width: 4; indent-tabs-mode: t -*-
+#
+# This file is part of the LibreOffice project.
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+# This file incorporates work covered by the following license notice:
+#
+#   Licensed to the Apache Software Foundation (ASF) under one or more
+#   contributor license agreements. See the NOTICE file distributed
+#   with this work for additional information regarding copyright
+#   ownership. The ASF licenses this file to you under the Apache
+#   License, Version 2.0 (the "License"); you may not use this file
+#   except in compliance with the License. You may obtain a copy of
+#   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+#
+
+$(eval $(call gb_Executable_Executable,lo_kde5filepicker))
+
+# FIXME: how to find the moc files automatically?!
+$(eval $(call gb_Executable_set_include,lo_kde5filepicker,\
+    $$(INCLUDE) \
+    -I$(SRCDIR)/vcl/inc \
+    -I$(WORKDIR)/CustomTarget/vcl/unx/gtk3_kde5 \
+))
+
+$(eval $(call gb_Executable_add_cxxflags,lo_kde5filepicker,\
+    $$(INCLUDE) \
+    $$(BOOST_CXXFLAGS) \
+))
+
+$(eval $(call gb_Executable_use_custom_headers,lo_kde5filepicker,\
+	officecfg/registry \
+))
+
+$(eval $(call gb_Executable_use_sdk_api,lo_kde5filepicker))
+
+$(eval $(call gb_Executable_add_libs,lo_kde5filepicker,\
+	-lX11 \
+	-lXext \
+	-lSM \
+	-lICE \
+))
+
+$(eval $(call gb_Executable_use_libraries,lo_kde5filepicker,\
+    vclplug_gen \
+    vcl \
+    tl \
+    utl \
+    sot \
+    ucbhelper \
+    basegfx \
+    comphelper \
+    cppuhelper \
+    i18nlangtag \
+    i18nutil \
+    $(if $(ENABLE_JAVA), \
+        jvmaccess) \
+    cppu \
+    sal \
+))
+
+$(eval $(call gb_Executable_use_externals,lo_kde5filepicker,\
+	boost_headers \
+	epoxy \
+	kde5 \
+	dbus \
+))
+
+$(eval $(call gb_Executable_add_defs,lo_kde5filepicker,\
+    $(QT5_CFLAGS) \
+    $(QT5_GLIB_CFLAGS) \
+    $(KF5_CFLAGS) \
+))
+$(eval $(call gb_Executable_add_libs,lo_kde5filepicker,\
+    $(QT5_LIBS) \
+    $(QT5_GLIB_LIBS) \
+    $(KF5_LIBS) \
+    $(BOOST_PROCESS_LIB) \
+    $(BOOST_FILESYSTEM_LIB) \
+))
+
+$(eval $(call gb_Executable_add_exception_objects,lo_kde5filepicker,\
+	vcl/unx/gtk3_kde5/kde5_lo_filepicker_main \
+	vcl/unx/gtk3_kde5/kde5_filepicker \
+	vcl/unx/gtk3_kde5/kde5_filepicker_ipc \
+))
+
+ifeq ($(OS),LINUX)
+$(eval $(call gb_Executable_add_libs,lo_kde5filepicker,\
+	-lm \
+	-ldl \
+	-lpthread \
+))
+endif
+
+# vim: set noet sw=4 ts=4:
diff -Naur libreoffice-6.0.2.1/vcl/Library_vclplug_gtk3_kde5.mk libreoffice-6.0.2.1-p/vcl/Library_vclplug_gtk3_kde5.mk
--- libreoffice-6.0.2.1/vcl/Library_vclplug_gtk3_kde5.mk	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/Library_vclplug_gtk3_kde5.mk	2018-03-02 13:47:33.373352476 +0100
@@ -0,0 +1,128 @@
+# -*- Mode: makefile-gmake; tab-width: 4; indent-tabs-mode: t -*-
+#
+# This file is part of the LibreOffice project.
+#
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#
+# This file incorporates work covered by the following license notice:
+#
+#   Licensed to the Apache Software Foundation (ASF) under one or more
+#   contributor license agreements. See the NOTICE file distributed
+#   with this work for additional information regarding copyright
+#   ownership. The ASF licenses this file to you under the Apache
+#   License, Version 2.0 (the "License"); you may not use this file
+#   except in compliance with the License. You may obtain a copy of
+#   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+#
+
+$(eval $(call gb_Library_Library,vclplug_gtk3_kde5))
+
+# Silence deprecation warnings wholesale as long as vcl/unx/gtk3/*.cxx just
+# forward to vcl/unx/gtk/*.cxx:
+$(eval $(call gb_Library_add_cxxflags,vclplug_gtk3_kde5, \
+    -Wno-deprecated-declarations \
+))
+
+$(eval $(call gb_Library_set_include,vclplug_gtk3_kde5,\
+    $$(INCLUDE) \
+    -I$(SRCDIR)/vcl/inc \
+    -I$(SRCDIR)/vcl/unx \
+    -I$(SRCDIR)/vcl/unx/gtk3 \
+))
+
+$(eval $(call gb_Library_add_cxxflags,vclplug_gtk3_kde5,\
+    $$(INCLUDE) \
+    $$(GTK3_CFLAGS) \
+))
+
+$(eval $(call gb_Library_add_defs,vclplug_gtk3_kde5,\
+    -DVCLPLUG_GTK_IMPLEMENTATION -DVCLPLUG_GTK3_KDE5_IMPLEMENTATION \
+))
+
+$(eval $(call gb_Library_use_custom_headers,vclplug_gtk3_kde5,\
+	officecfg/registry \
+))
+
+$(eval $(call gb_Library_use_sdk_api,vclplug_gtk3_kde5))
+
+$(eval $(call gb_Library_add_libs,vclplug_gtk3_kde5,\
+	$(GTK3_LIBS) \
+	$(GTHREAD_LIBS) \
+	-lX11 \
+	-lXext \
+	-lSM \
+	-lICE \
+))
+
+$(eval $(call gb_Library_use_libraries,vclplug_gtk3_kde5,\
+    vclplug_gen \
+    vcl \
+    tl \
+    utl \
+    sot \
+    ucbhelper \
+    basegfx \
+    comphelper \
+    cppuhelper \
+    i18nlangtag \
+    i18nutil \
+    $(if $(ENABLE_JAVA), \
+        jvmaccess) \
+    cppu \
+    sal \
+))
+
+$(eval $(call gb_Library_use_externals,vclplug_gtk3_kde5,\
+	boost_headers \
+	boost_filesystem \
+	epoxy \
+	dbus \
+))
+
+$(eval $(call gb_Library_add_exception_objects,vclplug_gtk3_kde5,\
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkaction \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkbridge \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkcomponent \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkeditabletext \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkfactory \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkhypertext \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkimage \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atklistener \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkregistry \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkselection \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktable \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktextattributes \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktext \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkutil \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkvalue \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwindow \
+	vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwrapper \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gtkdata \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gtkinst \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gtksys \
+	vcl/unx/gtk3_kde5/gtk3_kde5_filepicker \
+	vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc \
+	vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker \
+	vcl/unx/gtk3_kde5/gtk3_kde5_cairo \
+	vcl/unx/gtk3_kde5/gtk3_kde5_printwrapper \
+	vcl/unx/gtk3_kde5/gtk3_kde5_salnativewidgets-gtk \
+	vcl/unx/gtk3_kde5/gtk3_kde5_salprn-gtk \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gtkframe \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gtkobject \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gtksalmenu \
+	vcl/unx/gtk3_kde5/gtk3_kde5_glomenu \
+	vcl/unx/gtk3_kde5/gtk3_kde5_gloactiongroup \
+	vcl/unx/gtk3_kde5/gtk3_kde5_hudawareness \
+))
+
+ifeq ($(OS),LINUX)
+$(eval $(call gb_Library_add_libs,vclplug_gtk3_kde5,\
+	-lm \
+	-ldl \
+	-lpthread \
+))
+endif
+
+# vim: set noet sw=4 ts=4:
diff -Naur libreoffice-6.0.2.1/vcl/Module_vcl.mk libreoffice-6.0.2.1-p/vcl/Module_vcl.mk
--- libreoffice-6.0.2.1/vcl/Module_vcl.mk	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/Module_vcl.mk	2018-03-02 13:47:33.374352478 +0100
@@ -81,6 +81,7 @@
     Library_vclplug_kde4 \
 ))
 endif
+
 ifneq ($(ENABLE_KDE5),)
 $(eval $(call gb_Module_add_targets,vcl,\
     CustomTarget_kde5_moc \
@@ -93,6 +94,13 @@
     Library_vclplug_qt5 \
 ))
 endif
+ifneq ($(ENABLE_GTK3_KDE5),)
+$(eval $(call gb_Module_add_targets,vcl,\
+    CustomTarget_gtk3_kde5_moc \
+    Library_vclplug_gtk3_kde5 \
+    Executable_lo_kde5filepicker \
+))
+endif
 endif
 
 ifeq ($(OS),MACOSX)
diff -Naur libreoffice-6.0.2.1/vcl/unx/generic/plugadapt/salplug.cxx libreoffice-6.0.2.1-p/vcl/unx/generic/plugadapt/salplug.cxx
--- libreoffice-6.0.2.1/vcl/unx/generic/plugadapt/salplug.cxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/generic/plugadapt/salplug.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -100,7 +100,7 @@
                  * #i109007# KDE3 seems to have the same problem.
                  * And same applies for KDE4.
                  */
-                if( rModuleBase == "gtk" || rModuleBase == "gtk3" || rModuleBase == "kde4" )
+                if( rModuleBase == "gtk" || rModuleBase == "gtk3" || rModuleBase == "kde4" || rModuleBase == "gtk3_kde5")
                 {
                     pCloseModule = nullptr;
                 }
@@ -167,6 +167,9 @@
 {
     static const char* const pKDEFallbackList[] =
     {
+#if ENABLE_GTK3_KDE5
+        "gtk3_kde5",
+#endif
 #if ENABLE_KDE4
         "kde4",
 #endif
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk/gtkinst.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk/gtkinst.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk/gtkinst.cxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk/gtkinst.cxx	2018-03-02 13:47:33.409352560 +0100
@@ -186,7 +186,9 @@
 
     ImplSVData* pSVData = ImplGetSVData();
     delete pSVData->maAppData.mpToolkitName;
-#if GTK_CHECK_VERSION(3,0,0)
+#ifdef GTK_TOOLKIT_NAME
+    pSVData->maAppData.mpToolkitName = new OUString(GTK_TOOLKIT_NAME);
+#elif GTK_CHECK_VERSION(3,0,0)
     pSVData->maAppData.mpToolkitName = new OUString("gtk3");
 #else
     pSVData->maAppData.mpToolkitName = new OUString("gtk2");
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkaction.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkaction.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkaction.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkaction.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkaction.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkbridge.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkbridge.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkbridge.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkbridge.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkbridge.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkcomponent.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkcomponent.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkcomponent.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkcomponent.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkcomponent.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkeditabletext.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkeditabletext.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkeditabletext.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkeditabletext.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkeditabletext.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkfactory.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkfactory.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkfactory.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkfactory.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkfactory.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkhypertext.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkhypertext.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkhypertext.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkhypertext.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkhypertext.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkimage.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkimage.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkimage.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkimage.cxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkimage.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atklistener.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atklistener.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atklistener.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atklistener.cxx	2018-03-02 13:47:33.375352481 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atklistener.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkregistry.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkregistry.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkregistry.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkregistry.cxx	2018-03-02 13:47:33.375352481 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkregistry.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkselection.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkselection.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkselection.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkselection.cxx	2018-03-02 13:47:33.385352504 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkselection.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktable.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktable.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktable.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktable.cxx	2018-03-02 13:47:33.386352506 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atktable.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktextattributes.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktextattributes.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktextattributes.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktextattributes.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atktextattributes.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktext.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktext.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktext.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atktext.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atktext.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkutil.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkutil.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkutil.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkutil.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkutil.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkvalue.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkvalue.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkvalue.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkvalue.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkvalue.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwindow.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwindow.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwindow.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwindow.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkwindow.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwrapper.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwrapper.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwrapper.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/a11y/gtk3_kde5_atkwrapper.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,12 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ */
+
+#include "../../gtk/a11y/atkwrapper.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/filepicker_ipc_commands.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/filepicker_ipc_commands.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/filepicker_ipc_commands.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/filepicker_ipc_commands.hxx	2018-03-02 13:47:33.397352532 +0100
@@ -0,0 +1,161 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+#include <cstdint>
+#include <iostream>
+#include <vector>
+
+#include <sal/types.h>
+#include <com/sun/star/uno/Sequence.hxx>
+
+// #define DEBUG_FILEPICKER_IPC
+
+namespace rtl
+{
+class OUString;
+}
+class QString;
+
+enum class Commands : uint16_t
+{
+    SetTitle,
+    SetWinId,
+    Execute,
+    SetMultiSelectionMode,
+    SetDefaultName,
+    SetDisplayDirectory,
+    GetDisplayDirectory,
+    GetSelectedFiles,
+    AppendFilter,
+    SetCurrentFilter,
+    GetCurrentFilter,
+    SetValue,
+    GetValue,
+    EnableControl,
+    SetLabel,
+    GetLabel,
+    AddCheckBox,
+    Initialize,
+    Quit,
+    EnablePickFolderMode,
+};
+
+inline std::vector<char> readIpcStringArg(std::istream& stream)
+{
+    uint32_t length = 0;
+    stream >> length;
+    stream.ignore(); // skip space separator
+    std::vector<char> buffer(length, '\0');
+    stream.read(buffer.data(), length);
+    return buffer;
+}
+
+void readIpcArg(std::istream& stream, rtl::OUString& string);
+void readIpcArg(std::istream& stream, QString& string);
+void readIpcArg(std::istream& stream, css::uno::Sequence<rtl::OUString>& seq);
+
+inline void readIpcArg(std::istream& stream, Commands& value)
+{
+    uint16_t v = 0;
+    stream >> v;
+    stream.ignore(); // skip space
+    value = static_cast<Commands>(v);
+}
+
+void readIpcArg(std::istream&, sal_Bool) = delete;
+
+inline void readIpcArg(std::istream& stream, bool& value)
+{
+    stream >> value;
+    stream.ignore(); // skip space
+}
+
+inline void readIpcArg(std::istream& stream, sal_Int16& value)
+{
+    stream >> value;
+    stream.ignore(); // skip space
+}
+
+inline void readIpcArg(std::istream& stream, sal_uIntPtr& value)
+{
+    stream >> value;
+    stream.ignore(); // skip space
+}
+
+inline void readIpcArgs(std::istream& /*stream*/)
+{
+    // end of arguments, nothing to do
+}
+
+template <typename T, typename... Args>
+inline void readIpcArgs(std::istream& stream, T& arg, Args&... args)
+{
+    readIpcArg(stream, arg);
+    readIpcArgs(stream, args...);
+}
+
+void sendIpcArg(std::ostream& stream, const rtl::OUString& string);
+void sendIpcArg(std::ostream& stream, const QString& string);
+
+inline void sendIpcStringArg(std::ostream& stream, uint32_t length, const char* string)
+{
+    stream << length << ' ';
+    stream.write(string, length);
+    stream << ' ';
+}
+
+inline void sendIpcArg(std::ostream& stream, Commands value)
+{
+    stream << static_cast<uint16_t>(value) << ' ';
+}
+
+void sendIpcArg(std::ostream&, sal_Bool) = delete;
+
+inline void sendIpcArg(std::ostream& stream, bool value) { stream << value << ' '; }
+
+inline void sendIpcArg(std::ostream& stream, sal_Int16 value) { stream << value << ' '; }
+
+inline void sendIpcArg(std::ostream& stream, sal_uIntPtr value) { stream << value << ' '; }
+
+inline void sendIpcArgsImpl(std::ostream& stream)
+{
+    // end of arguments, flush stream
+    stream << std::endl;
+}
+
+template <typename T, typename... Args>
+inline void sendIpcArgsImpl(std::ostream& stream, const T& arg, const Args&... args)
+{
+    sendIpcArg(stream, arg);
+    sendIpcArgsImpl(stream, args...);
+}
+
+template <typename T, typename... Args>
+inline void sendIpcArgs(std::ostream& stream, const T& arg, const Args&... args)
+{
+    sendIpcArgsImpl(stream, arg, args...);
+#ifdef DEBUG_FILEPICKER_IPC
+    std::cerr << "IPC MSG: ";
+    sendIpcArgsImpl(std::cerr, arg, args...);
+#endif
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/FPServiceInfo.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/FPServiceInfo.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/FPServiceInfo.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/FPServiceInfo.hxx	2018-03-02 13:47:33.374352478 +0100
@@ -0,0 +1,28 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+// the service names
+#define FILE_PICKER_SERVICE_NAME "com.sun.star.ui.dialogs.Gtk3KDE5FilePicker"
+
+// the implementation names
+#define FILE_PICKER_IMPL_NAME "com.sun.star.ui.dialogs.Gtk3KDE5FilePicker"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_a11y.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_a11y.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_a11y.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_a11y.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,38 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/a11y/gtk3atkaction.cxx"
+#include "../gtk3/a11y/gtk3atkbridge.cxx"
+#include "../gtk3/a11y/gtk3atkcomponent.cxx"
+#include "../gtk3/a11y/gtk3atkeditabletext.cxx"
+#include "../gtk3/a11y/gtk3atkfactory.cxx"
+#include "../gtk3/a11y/gtk3atkhypertext.cxx"
+#include "../gtk3/a11y/gtk3atkimage.cxx"
+#include "../gtk3/a11y/gtk3atklistener.cxx"
+#include "../gtk3/a11y/gtk3atkregistry.cxx"
+#include "../gtk3/a11y/gtk3atkselection.cxx"
+#include "../gtk3/a11y/gtk3atktable.cxx"
+#include "../gtk3/a11y/gtk3atktextattributes.cxx"
+#include "../gtk3/a11y/gtk3atktext.cxx"
+#include "../gtk3/a11y/gtk3atkutil.cxx"
+#include "../gtk3/a11y/gtk3atkvalue.cxx"
+#include "../gtk3/a11y/gtk3atkwindow.cxx"
+#include "../gtk3/a11y/gtk3atkwrapper.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_cairo.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_cairo.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_cairo.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_cairo.cxx	2018-03-02 13:47:33.387352509 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/cairo_gtk3_cairo.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.cxx	2018-03-02 13:47:33.402352544 +0100
@@ -0,0 +1,446 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "gtk3_kde5_filepicker.hxx"
+
+#include <com/sun/star/lang/DisposedException.hpp>
+#include <com/sun/star/lang/XMultiServiceFactory.hpp>
+#include <com/sun/star/lang/IllegalArgumentException.hpp>
+#include <cppuhelper/interfacecontainer.h>
+#include <cppuhelper/supportsservice.hxx>
+#include <com/sun/star/ui/dialogs/TemplateDescription.hpp>
+#include <com/sun/star/ui/dialogs/CommonFilePickerElementIds.hpp>
+#include <com/sun/star/ui/dialogs/ExtendedFilePickerElementIds.hpp>
+#include <com/sun/star/ui/dialogs/ControlActions.hpp>
+#include <com/sun/star/ui/dialogs/ExecutableDialogResults.hpp>
+
+#include <osl/mutex.hxx>
+
+#include <fpicker/strings.hrc>
+
+#include "FPServiceInfo.hxx"
+
+#undef Region
+
+#include <unx/geninst.h>
+
+#include <strings.hrc>
+
+using namespace ::com::sun::star;
+using namespace ::com::sun::star::ui::dialogs;
+using namespace ::com::sun::star::ui::dialogs::TemplateDescription;
+using namespace ::com::sun::star::ui::dialogs::ExtendedFilePickerElementIds;
+using namespace ::com::sun::star::ui::dialogs::CommonFilePickerElementIds;
+using namespace ::com::sun::star::lang;
+using namespace ::com::sun::star::beans;
+using namespace ::com::sun::star::uno;
+
+// helper functions
+
+namespace
+{
+uno::Sequence<OUString> FilePicker_getSupportedServiceNames()
+{
+    uno::Sequence<OUString> aRet(3);
+    aRet[0] = "com.sun.star.ui.dialogs.FilePicker";
+    aRet[1] = "com.sun.star.ui.dialogs.SystemFilePicker";
+    aRet[2] = "com.sun.star.ui.dialogs.Gtk3KDE5FilePicker";
+    return aRet;
+}
+}
+
+// Gtk3KDE5FilePicker
+
+Gtk3KDE5FilePicker::Gtk3KDE5FilePicker(const uno::Reference<uno::XComponentContext>&)
+    : Gtk3KDE5FilePicker_Base(_helperMutex)
+{
+    setMultiSelectionMode(false);
+}
+
+Gtk3KDE5FilePicker::~Gtk3KDE5FilePicker() = default;
+
+void SAL_CALL
+Gtk3KDE5FilePicker::addFilePickerListener(const uno::Reference<XFilePickerListener>& xListener)
+{
+    SolarMutexGuard aGuard;
+    m_xListener = xListener;
+}
+
+void SAL_CALL
+Gtk3KDE5FilePicker::removeFilePickerListener(const uno::Reference<XFilePickerListener>&)
+{
+    SolarMutexGuard aGuard;
+    m_xListener.clear();
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::setTitle(const OUString& title)
+{
+    m_ipc.sendCommand(Commands::SetTitle, title);
+}
+
+sal_Int16 SAL_CALL Gtk3KDE5FilePicker::execute() { return m_ipc.execute(); }
+
+void SAL_CALL Gtk3KDE5FilePicker::setMultiSelectionMode(sal_Bool multiSelect)
+{
+    m_ipc.sendCommand(Commands::SetMultiSelectionMode, bool(multiSelect));
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::setDefaultName(const OUString& name)
+{
+    m_ipc.sendCommand(Commands::SetDefaultName, name);
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::setDisplayDirectory(const OUString& dir)
+{
+    m_ipc.sendCommand(Commands::SetDisplayDirectory, dir);
+}
+
+OUString SAL_CALL Gtk3KDE5FilePicker::getDisplayDirectory()
+{
+    auto id = m_ipc.sendCommand(Commands::GetDisplayDirectory);
+    OUString dir;
+    m_ipc.readResponse(id, dir);
+    return dir;
+}
+
+uno::Sequence<OUString> SAL_CALL Gtk3KDE5FilePicker::getFiles()
+{
+    uno::Sequence<OUString> seq = getSelectedFiles();
+    if (seq.getLength() > 1)
+        seq.realloc(1);
+    return seq;
+}
+
+uno::Sequence<OUString> SAL_CALL Gtk3KDE5FilePicker::getSelectedFiles()
+{
+    auto id = m_ipc.sendCommand(Commands::GetSelectedFiles);
+    uno::Sequence<OUString> seq;
+    m_ipc.readResponse(id, seq);
+    return seq;
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::appendFilter(const OUString& title, const OUString& filter)
+{
+    m_ipc.sendCommand(Commands::AppendFilter, title, filter);
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::setCurrentFilter(const OUString& title)
+{
+    m_ipc.sendCommand(Commands::SetCurrentFilter, title);
+}
+
+OUString SAL_CALL Gtk3KDE5FilePicker::getCurrentFilter()
+{
+    auto id = m_ipc.sendCommand(Commands::GetCurrentFilter);
+    OUString filter;
+    m_ipc.readResponse(id, filter);
+    return filter;
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::appendFilterGroup(const OUString& /*rGroupTitle*/,
+                                                    const uno::Sequence<beans::StringPair>& filters)
+{
+    const sal_uInt16 length = filters.getLength();
+    for (sal_uInt16 i = 0; i < length; ++i)
+    {
+        beans::StringPair aPair = filters[i];
+        appendFilter(aPair.First, aPair.Second);
+    }
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::setValue(sal_Int16 controlId, sal_Int16 nControlAction,
+                                           const uno::Any& value)
+{
+    if (value.has<bool>())
+    {
+        m_ipc.sendCommand(Commands::SetValue, controlId, nControlAction, value.get<bool>());
+    }
+    else
+    {
+        OSL_TRACE("set value of unhandled type %d", controlId);
+    }
+}
+
+uno::Any SAL_CALL Gtk3KDE5FilePicker::getValue(sal_Int16 controlId, sal_Int16 nControlAction)
+{
+    if (CHECKBOX_AUTOEXTENSION == controlId)
+        // We ignore this one and rely on QFileDialog to provide the function.
+        // Always return false, to pretend we do not support this, otherwise
+        // LO core would try to be smart and cut the extension in some places,
+        // interfering with QFileDialog's handling of it. QFileDialog also
+        // saves the value of the setting, so LO core is not needed for that either.
+        return uno::Any(false);
+
+    auto id = m_ipc.sendCommand(Commands::GetValue, controlId, nControlAction);
+
+    bool value = false;
+    m_ipc.readResponse(id, value);
+
+    return uno::Any(value);
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::enableControl(sal_Int16 controlId, sal_Bool enable)
+{
+    m_ipc.sendCommand(Commands::EnableControl, controlId, bool(enable));
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::setLabel(sal_Int16 controlId, const OUString& label)
+{
+    m_ipc.sendCommand(Commands::SetLabel, controlId, label);
+}
+
+OUString SAL_CALL Gtk3KDE5FilePicker::getLabel(sal_Int16 controlId)
+{
+    auto id = m_ipc.sendCommand(Commands::GetLabel, controlId);
+    OUString label;
+    m_ipc.readResponse(id, label);
+    return label;
+}
+
+void Gtk3KDE5FilePicker::addCustomControl(sal_Int16 controlId)
+{
+    const char* resId = nullptr;
+
+    switch (controlId)
+    {
+        case CHECKBOX_AUTOEXTENSION:
+            resId = STR_FPICKER_AUTO_EXTENSION;
+            break;
+        case CHECKBOX_PASSWORD:
+            resId = STR_FPICKER_PASSWORD;
+            break;
+        case CHECKBOX_FILTEROPTIONS:
+            resId = STR_FPICKER_FILTER_OPTIONS;
+            break;
+        case CHECKBOX_READONLY:
+            resId = STR_FPICKER_READONLY;
+            break;
+        case CHECKBOX_LINK:
+            resId = STR_FPICKER_INSERT_AS_LINK;
+            break;
+        case CHECKBOX_PREVIEW:
+            resId = STR_FPICKER_SHOW_PREVIEW;
+            break;
+        case CHECKBOX_SELECTION:
+            resId = STR_FPICKER_SELECTION;
+            break;
+        case CHECKBOX_GPGENCRYPTION:
+            resId = STR_FPICKER_GPGENCRYPT;
+            break;
+        case PUSHBUTTON_PLAY:
+            resId = STR_FPICKER_PLAY;
+            break;
+        case LISTBOX_VERSION:
+            resId = STR_FPICKER_VERSION;
+            break;
+        case LISTBOX_TEMPLATE:
+            resId = STR_FPICKER_TEMPLATES;
+            break;
+        case LISTBOX_IMAGE_TEMPLATE:
+            resId = STR_FPICKER_IMAGE_TEMPLATE;
+            break;
+        case LISTBOX_VERSION_LABEL:
+        case LISTBOX_TEMPLATE_LABEL:
+        case LISTBOX_IMAGE_TEMPLATE_LABEL:
+        case LISTBOX_FILTER_SELECTOR:
+            break;
+    }
+
+    switch (controlId)
+    {
+        case CHECKBOX_AUTOEXTENSION:
+        case CHECKBOX_PASSWORD:
+        case CHECKBOX_FILTEROPTIONS:
+        case CHECKBOX_READONLY:
+        case CHECKBOX_LINK:
+        case CHECKBOX_PREVIEW:
+        case CHECKBOX_SELECTION:
+        case CHECKBOX_GPGENCRYPTION:
+        {
+            // the checkbox is created even for CHECKBOX_AUTOEXTENSION to simplify
+            // code, but the checkbox is hidden and ignored
+            bool hidden = controlId == CHECKBOX_AUTOEXTENSION;
+
+            m_ipc.sendCommand(Commands::AddCheckBox, controlId, hidden, getResString(resId));
+
+            break;
+        }
+        case PUSHBUTTON_PLAY:
+        case LISTBOX_VERSION:
+        case LISTBOX_TEMPLATE:
+        case LISTBOX_IMAGE_TEMPLATE:
+        case LISTBOX_VERSION_LABEL:
+        case LISTBOX_TEMPLATE_LABEL:
+        case LISTBOX_IMAGE_TEMPLATE_LABEL:
+        case LISTBOX_FILTER_SELECTOR:
+            break;
+    }
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::initialize(const uno::Sequence<uno::Any>& args)
+{
+    // parameter checking
+    uno::Any arg;
+    if (args.getLength() == 0)
+    {
+        throw lang::IllegalArgumentException("no arguments", static_cast<XFilePicker2*>(this), 1);
+    }
+
+    arg = args[0];
+
+    if ((arg.getValueType() != cppu::UnoType<sal_Int16>::get())
+        && (arg.getValueType() != cppu::UnoType<sal_Int8>::get()))
+    {
+        throw lang::IllegalArgumentException("invalid argument type",
+                                             static_cast<XFilePicker2*>(this), 1);
+    }
+
+    sal_Int16 templateId = -1;
+    arg >>= templateId;
+
+    bool saveDialog = false;
+    switch (templateId)
+    {
+        case FILEOPEN_SIMPLE:
+            break;
+
+        case FILESAVE_SIMPLE:
+            saveDialog = true;
+            break;
+
+        case FILESAVE_AUTOEXTENSION:
+            saveDialog = true;
+            addCustomControl(CHECKBOX_AUTOEXTENSION);
+            break;
+
+        case FILESAVE_AUTOEXTENSION_PASSWORD:
+        {
+            saveDialog = true;
+            addCustomControl(CHECKBOX_PASSWORD);
+            addCustomControl(CHECKBOX_GPGENCRYPTION);
+            break;
+        }
+        case FILESAVE_AUTOEXTENSION_PASSWORD_FILTEROPTIONS:
+        {
+            saveDialog = true;
+            addCustomControl(CHECKBOX_AUTOEXTENSION);
+            addCustomControl(CHECKBOX_PASSWORD);
+            addCustomControl(CHECKBOX_GPGENCRYPTION);
+            addCustomControl(CHECKBOX_FILTEROPTIONS);
+            break;
+        }
+        case FILESAVE_AUTOEXTENSION_SELECTION:
+            saveDialog = true;
+            addCustomControl(CHECKBOX_AUTOEXTENSION);
+            addCustomControl(CHECKBOX_SELECTION);
+            break;
+
+        case FILESAVE_AUTOEXTENSION_TEMPLATE:
+            saveDialog = true;
+            addCustomControl(CHECKBOX_AUTOEXTENSION);
+            addCustomControl(LISTBOX_TEMPLATE);
+            break;
+
+        case FILEOPEN_LINK_PREVIEW_IMAGE_TEMPLATE:
+            addCustomControl(CHECKBOX_LINK);
+            addCustomControl(CHECKBOX_PREVIEW);
+            addCustomControl(LISTBOX_IMAGE_TEMPLATE);
+            break;
+
+        case FILEOPEN_PLAY:
+            addCustomControl(PUSHBUTTON_PLAY);
+            break;
+
+        case FILEOPEN_LINK_PLAY:
+            addCustomControl(CHECKBOX_LINK);
+            addCustomControl(PUSHBUTTON_PLAY);
+            break;
+
+        case FILEOPEN_READONLY_VERSION:
+            addCustomControl(CHECKBOX_READONLY);
+            addCustomControl(LISTBOX_VERSION);
+            break;
+
+        case FILEOPEN_LINK_PREVIEW:
+            addCustomControl(CHECKBOX_LINK);
+            addCustomControl(CHECKBOX_PREVIEW);
+            break;
+
+        case FILEOPEN_PREVIEW:
+            addCustomControl(CHECKBOX_PREVIEW);
+            break;
+
+        default:
+            OSL_TRACE("Unknown templates %d", templateId);
+            return;
+    }
+
+    setTitle(getResString(saveDialog ? STR_FPICKER_SAVE : STR_FPICKER_OPEN));
+
+    m_ipc.sendCommand(Commands::Initialize, saveDialog);
+}
+
+void SAL_CALL Gtk3KDE5FilePicker::cancel()
+{
+    // TODO
+}
+
+void Gtk3KDE5FilePicker::disposing(const lang::EventObject& rEvent)
+{
+    uno::Reference<XFilePickerListener> xFilePickerListener(rEvent.Source, uno::UNO_QUERY);
+
+    if (xFilePickerListener.is())
+    {
+        removeFilePickerListener(xFilePickerListener);
+    }
+}
+
+OUString SAL_CALL Gtk3KDE5FilePicker::getImplementationName()
+{
+    return OUString(FILE_PICKER_IMPL_NAME);
+}
+
+sal_Bool SAL_CALL Gtk3KDE5FilePicker::supportsService(const OUString& ServiceName)
+{
+    return cppu::supportsService(this, ServiceName);
+}
+
+uno::Sequence<OUString> SAL_CALL Gtk3KDE5FilePicker::getSupportedServiceNames()
+{
+    return FilePicker_getSupportedServiceNames();
+}
+
+void Gtk3KDE5FilePicker::filterChanged()
+{
+    FilePickerEvent aEvent;
+    aEvent.ElementId = LISTBOX_FILTER;
+    OSL_TRACE("filter changed");
+    if (m_xListener.is())
+        m_xListener->controlStateChanged(aEvent);
+}
+
+void Gtk3KDE5FilePicker::selectionChanged()
+{
+    FilePickerEvent aEvent;
+    OSL_TRACE("file selection changed");
+    if (m_xListener.is())
+        m_xListener->fileSelectionChanged(aEvent);
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker.hxx	2018-03-02 13:47:33.402352544 +0100
@@ -0,0 +1,136 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+#include <cppuhelper/compbase.hxx>
+
+#include <com/sun/star/lang/XServiceInfo.hpp>
+#include <com/sun/star/lang/XInitialization.hpp>
+#include <com/sun/star/ui/dialogs/XFilePicker3.hpp>
+#include <com/sun/star/ui/dialogs/XFilePickerControlAccess.hpp>
+#include <com/sun/star/uno/XComponentContext.hpp>
+
+#include <osl/conditn.hxx>
+#include <osl/mutex.hxx>
+
+#include <rtl/ustrbuf.hxx>
+
+#include "gtk3_kde5_filepicker_ipc.hxx"
+
+#include <functional>
+
+typedef ::cppu::WeakComponentImplHelper<css::ui::dialogs::XFilePicker3,
+                                        css::ui::dialogs::XFilePickerControlAccess
+                                        // TODO css::ui::dialogs::XFilePreview
+                                        ,
+                                        css::lang::XInitialization, css::lang::XServiceInfo>
+    Gtk3KDE5FilePicker_Base;
+
+class Gtk3KDE5FilePicker : public Gtk3KDE5FilePicker_Base
+{
+protected:
+    css::uno::Reference<css::ui::dialogs::XFilePickerListener> m_xListener;
+
+    osl::Mutex _helperMutex;
+    Gtk3KDE5FilePickerIpc m_ipc;
+
+public:
+    explicit Gtk3KDE5FilePicker(const css::uno::Reference<css::uno::XComponentContext>&);
+    virtual ~Gtk3KDE5FilePicker() override;
+
+    // XFilePickerNotifier
+    virtual void SAL_CALL addFilePickerListener(
+        const css::uno::Reference<css::ui::dialogs::XFilePickerListener>& xListener) override;
+    virtual void SAL_CALL removeFilePickerListener(
+        const css::uno::Reference<css::ui::dialogs::XFilePickerListener>& xListener) override;
+
+    // XExecutableDialog functions
+    virtual void SAL_CALL setTitle(const OUString& rTitle) override;
+    virtual sal_Int16 SAL_CALL execute() override;
+
+    // XFilePicker functions
+    virtual void SAL_CALL setMultiSelectionMode(sal_Bool bMode) override;
+    virtual void SAL_CALL setDefaultName(const OUString& rName) override;
+    virtual void SAL_CALL setDisplayDirectory(const OUString& rDirectory) override;
+    virtual OUString SAL_CALL getDisplayDirectory() override;
+    virtual css::uno::Sequence<OUString> SAL_CALL getFiles() override;
+
+    // XFilterManager functions
+    virtual void SAL_CALL appendFilter(const OUString& rTitle, const OUString& rFilter) override;
+    virtual void SAL_CALL setCurrentFilter(const OUString& rTitle) override;
+    virtual OUString SAL_CALL getCurrentFilter() override;
+
+    // XFilterGroupManager functions
+    virtual void SAL_CALL
+    appendFilterGroup(const OUString& rGroupTitle,
+                      const css::uno::Sequence<css::beans::StringPair>& rFilters) override;
+
+    // XFilePickerControlAccess functions
+    virtual void SAL_CALL setValue(sal_Int16 nControlId, sal_Int16 nControlAction,
+                                   const css::uno::Any& rValue) override;
+    virtual css::uno::Any SAL_CALL getValue(sal_Int16 nControlId,
+                                            sal_Int16 nControlAction) override;
+    virtual void SAL_CALL enableControl(sal_Int16 nControlId, sal_Bool bEnable) override;
+    virtual void SAL_CALL setLabel(sal_Int16 nControlId, const OUString& rLabel) override;
+    virtual OUString SAL_CALL getLabel(sal_Int16 nControlId) override;
+
+    /* TODO XFilePreview
+
+    virtual css::uno::Sequence< sal_Int16 > SAL_CALL getSupportedImageFormats(  );
+    virtual sal_Int32 SAL_CALL  getTargetColorDepth(  );
+    virtual sal_Int32 SAL_CALL  getAvailableWidth(  );
+    virtual sal_Int32 SAL_CALL  getAvailableHeight(  );
+    virtual void SAL_CALL       setImage( sal_Int16 aImageFormat, const css::uno::Any &rImage );
+    virtual sal_Bool SAL_CALL   setShowState( sal_Bool bShowState );
+    virtual sal_Bool SAL_CALL   getShowState(  );
+    */
+
+    // XFilePicker2 functions
+    virtual css::uno::Sequence<OUString> SAL_CALL getSelectedFiles() override;
+
+    // XInitialization
+    virtual void SAL_CALL initialize(const css::uno::Sequence<css::uno::Any>& rArguments) override;
+
+    // XCancellable
+    virtual void SAL_CALL cancel() override;
+
+    // XEventListener
+    virtual void disposing(const css::lang::EventObject& rEvent);
+    using cppu::WeakComponentImplHelperBase::disposing;
+
+    // XServiceInfo
+    virtual OUString SAL_CALL getImplementationName() override;
+    virtual sal_Bool SAL_CALL supportsService(const OUString& rServiceName) override;
+    virtual css::uno::Sequence<OUString> SAL_CALL getSupportedServiceNames() override;
+
+private:
+    Gtk3KDE5FilePicker(const Gtk3KDE5FilePicker&) = delete;
+    Gtk3KDE5FilePicker& operator=(const Gtk3KDE5FilePicker&) = delete;
+
+    //add a custom control widget to the file dialog
+    void addCustomControl(sal_Int16 controlId);
+
+    // emit XFilePickerListener controlStateChanged event
+    void filterChanged();
+    // emit XFilePickerListener fileSelectionChanged event
+    void selectionChanged();
+};
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.cxx	2018-03-02 13:47:33.402352544 +0100
@@ -0,0 +1,259 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "gtk3_kde5_filepicker_ipc.hxx"
+
+#undef Region
+
+#include <unx/geninst.h>
+
+#include <strings.hrc>
+
+#include <future>
+#include <system_error>
+
+#include <com/sun/star/ui/dialogs/ExecutableDialogResults.hpp>
+
+#include <vcl/svapp.hxx>
+#include <vcl/sysdata.hxx>
+#include <vcl/syswin.hxx>
+
+#include <osl/file.h>
+#include <osl/process.h>
+
+#include <gtk/gtk.h>
+#include <gdk/gdkx.h>
+#include <unx/gtk/gtkdata.hxx>
+
+#include <boost/filesystem/path.hpp>
+
+using namespace ::com::sun::star::ui::dialogs;
+
+// helper functions
+
+namespace
+{
+OUString applicationDirPath()
+{
+    OUString applicationFilePath;
+    osl_getExecutableFile(&applicationFilePath.pData);
+    OUString applicationSystemPath;
+    osl_getSystemPathFromFileURL(applicationFilePath.pData, &applicationSystemPath.pData);
+    const auto utf8Path = applicationSystemPath.toUtf8();
+    auto ret = boost::filesystem::path(utf8Path.getStr(), utf8Path.getStr() + utf8Path.getLength());
+    ret.remove_filename();
+    return OUString::fromUtf8(OString(ret.c_str(), ret.size()));
+}
+
+OUString findPickerExecutable()
+{
+    const auto path = applicationDirPath();
+    const OUString app("lo_kde5filepicker");
+    OUString ret;
+    osl_searchFileURL(app.pData, path.pData, &ret.pData);
+    if (ret.isEmpty())
+        throw std::system_error(std::make_error_code(std::errc::no_such_file_or_directory),
+                                "could not find lo_kde5filepicker executable");
+    return ret;
+}
+}
+
+void readIpcArg(std::istream& stream, OUString& str)
+{
+    const auto buffer = readIpcStringArg(stream);
+    str = OUString::fromUtf8(OString(buffer.data(), buffer.size()));
+}
+
+void readIpcArg(std::istream& stream, css::uno::Sequence<OUString>& seq)
+{
+    uint32_t numFiles = 0;
+    stream >> numFiles;
+    stream.ignore(); // skip space;
+    seq.realloc(numFiles);
+    for (size_t i = 0; i < numFiles; ++i)
+    {
+        readIpcArg(stream, seq[i]);
+    }
+}
+
+void sendIpcArg(std::ostream& stream, const OUString& string)
+{
+    const auto utf8 = string.toUtf8();
+    sendIpcStringArg(stream, utf8.getLength(), utf8.getStr());
+}
+
+OUString getResString(const char* pResId)
+{
+    if (pResId == nullptr)
+        return {};
+
+    return VclResId(pResId);
+}
+
+// Gtk3KDE5FilePicker
+
+Gtk3KDE5FilePickerIpc::Gtk3KDE5FilePickerIpc()
+{
+    const auto exe = findPickerExecutable();
+    oslProcessError result;
+    oslSecurity pSecurity = osl_getCurrentSecurity();
+    result = osl_executeProcess_WithRedirectedIO(exe.pData, nullptr, 0, osl_Process_NORMAL,
+                                                 pSecurity, nullptr, nullptr, 0, &m_process,
+                                                 &m_inputWrite, &m_outputRead, nullptr);
+    osl_freeSecurityHandle(pSecurity);
+    if (result != osl_Process_E_None)
+        throw std::system_error(std::make_error_code(std::errc::no_such_process),
+                                "could not start lo_kde5filepicker executable");
+}
+
+Gtk3KDE5FilePickerIpc::~Gtk3KDE5FilePickerIpc()
+{
+    if (!m_process)
+        return;
+
+    sendCommand(Commands::Quit);
+    TimeValue timeValue(std::chrono::milliseconds(100));
+    if (osl_joinProcessWithTimeout(m_process, &timeValue) != osl_Process_E_None)
+        osl_terminateProcess(m_process);
+
+    if (m_inputWrite)
+        osl_closeFile(m_inputWrite);
+    if (m_outputRead)
+        osl_closeFile(m_outputRead);
+    osl_freeProcessHandle(m_process);
+}
+
+sal_Int16 Gtk3KDE5FilePickerIpc::execute()
+{
+    auto restoreMainWindow = blockMainWindow();
+
+    auto id = sendCommand(Commands::Execute);
+    bool accepted = false;
+    readResponse(id, accepted);
+
+    if (restoreMainWindow)
+        restoreMainWindow();
+
+    return accepted ? ExecutableDialogResults::OK : ExecutableDialogResults::CANCEL;
+}
+
+static gboolean ignoreDeleteEvent(GtkWidget* /*widget*/, GdkEvent* /*event*/,
+                                  gpointer /*user_data*/)
+{
+    return true;
+}
+
+std::function<void()> Gtk3KDE5FilePickerIpc::blockMainWindow()
+{
+    vcl::Window* pParentWin = Application::GetDefDialogParent();
+    if (!pParentWin)
+        return {};
+
+    const SystemEnvData* pSysData = static_cast<SystemWindow*>(pParentWin)->GetSystemData();
+    if (!pSysData)
+        return {};
+
+    sendCommand(Commands::SetWinId, pSysData->aWindow);
+
+    auto* pMainWindow = static_cast<GtkWidget*>(pSysData->pWidget);
+    if (!pMainWindow)
+        return {};
+
+    SolarMutexGuard guard;
+    auto deleteEventSignalId = g_signal_lookup("delete_event", gtk_widget_get_type());
+
+    // disable the mainwindow
+    gtk_widget_set_sensitive(pMainWindow, false);
+
+    // block the GtkSalFrame delete_event handler
+    auto blockedHandler = g_signal_handler_find(
+        pMainWindow, static_cast<GSignalMatchType>(G_SIGNAL_MATCH_ID | G_SIGNAL_MATCH_DATA),
+        deleteEventSignalId, 0, nullptr, nullptr, pSysData->pSalFrame);
+    g_signal_handler_block(pMainWindow, blockedHandler);
+
+    // prevent the window from being closed
+    auto ignoreDeleteEventHandler
+        = g_signal_connect(pMainWindow, "delete_event", G_CALLBACK(ignoreDeleteEvent), nullptr);
+
+    return [pMainWindow, ignoreDeleteEventHandler, blockedHandler] {
+        SolarMutexGuard cleanupGuard;
+        // re-enable window
+        gtk_widget_set_sensitive(pMainWindow, true);
+
+        // allow it to be closed again
+        g_signal_handler_disconnect(pMainWindow, ignoreDeleteEventHandler);
+
+        // unblock the GtkSalFrame handler
+        g_signal_handler_unblock(pMainWindow, blockedHandler);
+    };
+}
+
+void Gtk3KDE5FilePickerIpc::await(const std::future<void>& future)
+{
+    while (future.wait_for(std::chrono::milliseconds(1)) != std::future_status::ready)
+    {
+        GetGtkSalData()->Yield(false, true);
+    }
+}
+
+void Gtk3KDE5FilePickerIpc::writeResponseLine(const std::string& line)
+{
+    sal_uInt64 bytesWritten = 0;
+    osl_writeFile(m_inputWrite, line.c_str(), line.size(), &bytesWritten);
+}
+
+std::string Gtk3KDE5FilePickerIpc::readResponseLine()
+{
+    if (!m_responseBuffer.empty()) // check whether we have a line in our buffer
+    {
+        auto it = m_responseBuffer.find('\n');
+        if (it != std::string::npos)
+        {
+            auto ret = m_responseBuffer.substr(0, it);
+            m_responseBuffer.erase(0, it);
+            return ret;
+        }
+    }
+
+    const sal_uInt64 BUF_SIZE = 1024;
+    char buffer[BUF_SIZE];
+    while (true)
+    {
+        sal_uInt64 bytesRead = 0;
+        auto err = osl_readFile(m_outputRead, buffer, BUF_SIZE, &bytesRead);
+        auto it = std::find(buffer, buffer + bytesRead, '\n');
+        if (it != buffer + bytesRead) // check whether the chunk we read contains an EOL
+        {
+            // if so, append that part to the buffer and return it
+            std::string ret = m_responseBuffer.append(buffer, it);
+            // but keep anything else we may have read in our buffer
+            ++it;
+            m_responseBuffer.assign(it, buffer + bytesRead);
+            return ret;
+        }
+        // otherwise append everything we read to the buffer and try again
+        m_responseBuffer.append(buffer, bytesRead);
+
+        if (err != osl_File_E_None && err != osl_File_E_AGAIN)
+            break;
+    }
+    return {};
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_filepicker_ipc.hxx	2018-03-02 13:47:33.402352544 +0100
@@ -0,0 +1,114 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+#include <cppuhelper/compbase.hxx>
+
+#include <osl/conditn.hxx>
+#include <osl/mutex.hxx>
+#include <osl/process.h>
+
+#include <rtl/ustrbuf.hxx>
+
+#include "filepicker_ipc_commands.hxx"
+
+#include <functional>
+#include <future>
+#include <mutex>
+#include <thread>
+#include <sstream>
+
+OUString getResString(const char* pResId);
+
+class Gtk3KDE5FilePickerIpc
+{
+protected:
+    oslProcess m_process;
+    oslFileHandle m_inputWrite;
+    oslFileHandle m_outputRead;
+    // simple multiplexing: every command gets it's own ID that can be used to
+    // read the corresponding response
+    uint64_t m_msgId = 1;
+    std::mutex m_mutex;
+    uint64_t m_incomingResponse = 0;
+    std::string m_responseBuffer;
+    std::stringstream m_responseStream;
+
+public:
+    explicit Gtk3KDE5FilePickerIpc();
+    ~Gtk3KDE5FilePickerIpc();
+
+    sal_Int16 execute();
+
+    void writeResponseLine(const std::string& line);
+
+    template <typename... Args> uint64_t sendCommand(Commands command, const Args&... args)
+    {
+        auto id = m_msgId;
+        ++m_msgId;
+        std::stringstream stream;
+        sendIpcArgs(stream, id, command, args...);
+        writeResponseLine(stream.str());
+        return id;
+    }
+
+    std::string readResponseLine();
+
+    template <typename... Args> void readResponse(uint64_t id, Args&... args)
+    {
+        // read synchronously from a background thread and run the eventloop until the value becomes available
+        // this allows us to keep the GUI responsive and also enables access to the LO clipboard
+        await(std::async(std::launch::async, [&]() {
+            while (true)
+            {
+                // only let one thread read at any given time
+                std::lock_guard<std::mutex> lock(m_mutex);
+
+                // check if we need to read (and potentially wait) a response ID
+                if (m_incomingResponse == 0)
+                {
+                    m_responseStream.clear();
+                    m_responseStream.str(readResponseLine());
+                    readIpcArgs(m_responseStream, m_incomingResponse);
+                }
+
+                if (m_incomingResponse == id)
+                {
+                    // the response we are waiting for came in
+                    readIpcArgs(m_responseStream, args...);
+                    m_incomingResponse = 0;
+                    break;
+                }
+                else
+                {
+                    // the next response answers some other request, yield
+                    std::this_thread::yield();
+                }
+            }
+        }));
+    }
+
+private:
+    std::function<void()> blockMainWindow();
+
+    static void await(const std::future<void>& future);
+};
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.cxx	2018-03-02 13:47:33.388352511 +0100
@@ -0,0 +1,88 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "gtk3_kde5_folderpicker.hxx"
+
+#include <com/sun/star/awt/Toolkit.hpp>
+#include <com/sun/star/frame/Desktop.hpp>
+#include <com/sun/star/lang/XMultiComponentFactory.hpp>
+#include <com/sun/star/ui/dialogs/ExecutableDialogResults.hpp>
+#include <com/sun/star/ui/dialogs/CommonFilePickerElementIds.hpp>
+#include <com/sun/star/ui/dialogs/ExtendedFilePickerElementIds.hpp>
+#include <com/sun/star/ui/dialogs/TemplateDescription.hpp>
+#include <vcl/svapp.hxx>
+
+#include <strings.hrc>
+
+using namespace ::com::sun::star;
+using namespace ::com::sun::star::ui::dialogs;
+using namespace ::com::sun::star::lang;
+using namespace ::com::sun::star::uno;
+
+// constructor
+
+Gtk3KDE5FolderPicker::Gtk3KDE5FolderPicker(
+    const uno::Reference<uno::XComponentContext>& /*xContext*/)
+{
+    m_ipc.sendCommand(Commands::EnablePickFolderMode);
+    setTitle(getResString(STR_FPICKER_FOLDER_DEFAULT_TITLE));
+}
+
+Gtk3KDE5FolderPicker::~Gtk3KDE5FolderPicker() = default;
+
+void SAL_CALL Gtk3KDE5FolderPicker::setDisplayDirectory(const OUString& aDirectory)
+{
+    m_ipc.sendCommand(Commands::SetDisplayDirectory, aDirectory);
+}
+
+OUString SAL_CALL Gtk3KDE5FolderPicker::getDisplayDirectory()
+{
+    auto id = m_ipc.sendCommand(Commands::GetDisplayDirectory);
+    OUString ret;
+    m_ipc.readResponse(id, ret);
+    return ret;
+}
+
+OUString SAL_CALL Gtk3KDE5FolderPicker::getDirectory()
+{
+    auto id = m_ipc.sendCommand(Commands::GetSelectedFiles);
+    uno::Sequence<OUString> seq;
+    m_ipc.readResponse(id, seq);
+    return seq.hasElements() ? seq[0] : OUString();
+}
+
+void SAL_CALL Gtk3KDE5FolderPicker::setDescription(const OUString& /*rDescription*/) {}
+
+// XExecutableDialog functions
+
+void SAL_CALL Gtk3KDE5FolderPicker::setTitle(const OUString& aTitle)
+{
+    m_ipc.sendCommand(Commands::SetTitle, aTitle);
+}
+
+sal_Int16 SAL_CALL Gtk3KDE5FolderPicker::execute() { return m_ipc.execute(); }
+
+// XCancellable
+
+void SAL_CALL Gtk3KDE5FolderPicker::cancel()
+{
+    // TODO
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_folderpicker.hxx	2018-03-02 13:47:33.398352534 +0100
@@ -0,0 +1,61 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+#include <list>
+#include <memory>
+#include <rtl/ustring.hxx>
+#include <cppuhelper/implbase.hxx>
+
+#include <com/sun/star/ui/dialogs/XFolderPicker2.hpp>
+#include <com/sun/star/uno/XComponentContext.hpp>
+
+#include "gtk3_kde5_filepicker_ipc.hxx"
+
+class Gtk3KDE5FolderPicker : public cppu::WeakImplHelper<css::ui::dialogs::XFolderPicker2>
+{
+protected:
+    Gtk3KDE5FilePickerIpc m_ipc;
+
+public:
+    // constructor
+    explicit Gtk3KDE5FolderPicker(
+        const css::uno::Reference<css::uno::XComponentContext>& xServiceMgr);
+    virtual ~Gtk3KDE5FolderPicker() override;
+
+    // XExecutableDialog functions
+    virtual void SAL_CALL setTitle(const OUString& aTitle) override;
+    virtual sal_Int16 SAL_CALL execute() override;
+
+    // XFolderPicker functions
+    virtual void SAL_CALL setDisplayDirectory(const OUString& rDirectory) override;
+    virtual OUString SAL_CALL getDisplayDirectory() override;
+    virtual OUString SAL_CALL getDirectory() override;
+    virtual void SAL_CALL setDescription(const OUString& rDescription) override;
+
+    // XCancellable
+    virtual void SAL_CALL cancel() override;
+
+private:
+    Gtk3KDE5FolderPicker(const Gtk3KDE5FolderPicker&) = delete;
+    Gtk3KDE5FolderPicker& operator=(const Gtk3KDE5FolderPicker&) = delete;
+};
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gloactiongroup.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gloactiongroup.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gloactiongroup.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gloactiongroup.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gloactiongroup.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_glomenu.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_glomenu.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_glomenu.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_glomenu.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3glomenu.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkdata.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkdata.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkdata.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkdata.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gtkdata.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkframe.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkframe.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkframe.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkframe.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gtkframe.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkinst.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkinst.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkinst.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkinst.cxx	2018-03-02 13:47:33.409352560 +0100
@@ -0,0 +1,57 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+// make gtk3 plug advertise correctly as kde5 hybrid
+#define GTK_TOOLKIT_NAME "gtk3_kde5"
+#include "../gtk3/gtk3gtkinst.cxx"
+
+#include "gtk3_kde5_filepicker.hxx"
+#include "gtk3_kde5_folderpicker.hxx"
+
+#include <system_error>
+
+uno::Reference<ui::dialogs::XFilePicker2>
+GtkInstance::createFilePicker(const uno::Reference<uno::XComponentContext>& xMSF)
+{
+    try
+    {
+        return uno::Reference<ui::dialogs::XFilePicker2>(new Gtk3KDE5FilePicker(xMSF));
+    }
+    catch (const std::system_error& error)
+    {
+        OSL_FAIL(error.what());
+        return { nullptr };
+    }
+}
+
+uno::Reference<ui::dialogs::XFolderPicker2>
+GtkInstance::createFolderPicker(const uno::Reference<uno::XComponentContext>& xMSF)
+{
+    try
+    {
+        return uno::Reference<ui::dialogs::XFolderPicker2>(new Gtk3KDE5FolderPicker(xMSF));
+    }
+    catch (const std::system_error& error)
+    {
+        OSL_FAIL(error.what());
+        return { nullptr };
+    }
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkobject.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkobject.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtkobject.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtkobject.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gtkobject.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtksalmenu.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtksalmenu.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtksalmenu.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtksalmenu.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gtksalmenu.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtksys.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtksys.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_gtksys.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_gtksys.cxx	2018-03-02 13:47:33.392352520 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gtksys.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_hudawareness.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_hudawareness.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_hudawareness.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_hudawareness.cxx	2018-03-02 13:47:33.393352523 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3hudawareness.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_printwrapper.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_printwrapper.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_printwrapper.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_printwrapper.cxx	2018-03-02 13:47:33.393352523 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3gtkprintwrapper.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_salnativewidgets-gtk.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_salnativewidgets-gtk.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_salnativewidgets-gtk.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_salnativewidgets-gtk.cxx	2018-03-02 13:47:33.393352523 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3salnativewidgets-gtk.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_salprn-gtk.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_salprn-gtk.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/gtk3_kde5_salprn-gtk.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/gtk3_kde5_salprn-gtk.cxx	2018-03-02 13:47:33.393352523 +0100
@@ -0,0 +1,22 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "../gtk3/gtk3salprn-gtk.cxx"
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker.cxx	2018-03-02 13:47:33.410352563 +0100
@@ -0,0 +1,246 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "kde5_filepicker.hxx"
+
+#include <KWindowSystem>
+#include <KFileWidget>
+
+#include <QtCore/QDebug>
+#include <QtCore/QUrl>
+#include <QtGui/QClipboard>
+#include <QtGui/QWindow>
+#include <QtWidgets/QCheckBox>
+#include <QtWidgets/QFileDialog>
+#include <QtWidgets/QGridLayout>
+#include <QtWidgets/QWidget>
+#include <QtWidgets/QApplication>
+
+// KDE5FilePicker
+
+KDE5FilePicker::KDE5FilePicker(QObject* parent)
+    : QObject(parent)
+    , _dialog(new QFileDialog(nullptr, {}, QDir::homePath()))
+    , _extraControls(new QWidget)
+    , _layout(new QGridLayout(_extraControls))
+    , _winId(0)
+    , allowRemoteUrls(false)
+{
+    _dialog->setSupportedSchemes({
+        QStringLiteral("file"),
+        QStringLiteral("ftp"),
+        QStringLiteral("http"),
+        QStringLiteral("https"),
+        QStringLiteral("webdav"),
+        QStringLiteral("webdavs"),
+        QStringLiteral("smb"),
+    });
+
+    setMultiSelectionMode(false);
+
+    connect(_dialog, &QFileDialog::filterSelected, this, &KDE5FilePicker::filterChanged);
+    connect(_dialog, &QFileDialog::fileSelected, this, &KDE5FilePicker::selectionChanged);
+
+    qApp->installEventFilter(this);
+}
+
+void KDE5FilePicker::enableFolderMode()
+{
+    _dialog->setOption(QFileDialog::ShowDirsOnly, true);
+    _dialog->setFileMode(QFileDialog::Directory);
+}
+
+KDE5FilePicker::~KDE5FilePicker()
+{
+    delete _extraControls;
+    delete _dialog;
+}
+
+void KDE5FilePicker::setTitle(const QString& title) { _dialog->setWindowTitle(title); }
+
+bool KDE5FilePicker::execute()
+{
+    if (!_filters.isEmpty())
+        _dialog->setNameFilters(_filters);
+    if (!_currentFilter.isEmpty())
+        _dialog->selectNameFilter(_currentFilter);
+
+    _dialog->show();
+    //block and wait for user input
+    return _dialog->exec() == QFileDialog::Accepted;
+}
+
+void KDE5FilePicker::setMultiSelectionMode(bool multiSelect)
+{
+    _dialog->setFileMode(multiSelect ? QFileDialog::ExistingFiles : QFileDialog::ExistingFile);
+}
+
+void KDE5FilePicker::setDefaultName(const QString& name) { _dialog->selectUrl(QUrl(name)); }
+
+void KDE5FilePicker::setDisplayDirectory(const QString& dir) { _dialog->selectUrl(QUrl(dir)); }
+
+QString KDE5FilePicker::getDisplayDirectory() const { return _dialog->directoryUrl().url(); }
+
+QList<QUrl> KDE5FilePicker::getSelectedFiles() const { return _dialog->selectedUrls(); }
+
+void KDE5FilePicker::appendFilter(const QString& title, const QString& filter)
+{
+    QString t = title;
+    QString f = filter;
+    // '/' need to be escaped else they are assumed to be mime types by kfiledialog
+    //see the docs
+    t.replace("/", "\\/");
+
+    // openoffice gives us filters separated by ';' qt dialogs just want space separated
+    f.replace(";", " ");
+
+    // make sure "*.*" is not used as "all files"
+    f.replace("*.*", "*");
+
+    _filters << QStringLiteral("%1 (%2)").arg(t, f);
+    _titleToFilters[t] = _filters.constLast();
+}
+
+void KDE5FilePicker::setCurrentFilter(const QString& title)
+{
+    _currentFilter = _titleToFilters.value(title);
+}
+
+QString KDE5FilePicker::getCurrentFilter() const
+{
+    QString filter = _titleToFilters.key(_dialog->selectedNameFilter());
+
+    //default if not found
+    if (filter.isEmpty())
+        filter = "ODF Text Document (.odt)";
+
+    return filter;
+}
+
+void KDE5FilePicker::setValue(sal_Int16 controlId, sal_Int16 /*nControlAction*/, bool value)
+{
+    if (_customWidgets.contains(controlId))
+    {
+        QCheckBox* cb = dynamic_cast<QCheckBox*>(_customWidgets.value(controlId));
+        if (cb)
+            cb->setChecked(value);
+    }
+    else
+        qWarning() << "set value on unknown control" << controlId;
+}
+
+bool KDE5FilePicker::getValue(sal_Int16 controlId, sal_Int16 /*nControlAction*/) const
+{
+    bool ret = false;
+    if (_customWidgets.contains(controlId))
+    {
+        QCheckBox* cb = dynamic_cast<QCheckBox*>(_customWidgets.value(controlId));
+        if (cb)
+            ret = cb->isChecked();
+    }
+    else
+        qWarning() << "get value on unknown control" << controlId;
+
+    return ret;
+}
+
+void KDE5FilePicker::enableControl(sal_Int16 controlId, bool enable)
+{
+    if (_customWidgets.contains(controlId))
+        _customWidgets.value(controlId)->setEnabled(enable);
+    else
+        qWarning() << "enable on unknown control" << controlId;
+}
+
+void KDE5FilePicker::setLabel(sal_Int16 controlId, const QString& label)
+{
+    if (_customWidgets.contains(controlId))
+    {
+        QCheckBox* cb = dynamic_cast<QCheckBox*>(_customWidgets.value(controlId));
+        if (cb)
+            cb->setText(label);
+    }
+    else
+        qWarning() << "set label on unknown control" << controlId;
+}
+
+QString KDE5FilePicker::getLabel(sal_Int16 controlId) const
+{
+    QString label;
+    if (_customWidgets.contains(controlId))
+    {
+        QCheckBox* cb = dynamic_cast<QCheckBox*>(_customWidgets.value(controlId));
+        if (cb)
+            label = cb->text();
+    }
+    else
+        qWarning() << "get label on unknown control" << controlId;
+
+    return label;
+}
+
+void KDE5FilePicker::addCheckBox(sal_Int16 controlId, const QString& label, bool hidden)
+{
+    auto resString = label;
+    resString.replace('~', '&');
+
+    auto widget = new QCheckBox(resString, _extraControls);
+    widget->setHidden(hidden);
+    if (!hidden)
+    {
+        _layout->addWidget(widget);
+    }
+    _customWidgets.insert(controlId, widget);
+}
+
+void KDE5FilePicker::initialize(bool saveDialog)
+{
+    //default is opening
+    QFileDialog::AcceptMode operationMode
+        = saveDialog ? QFileDialog::AcceptSave : QFileDialog::AcceptOpen;
+
+    _dialog->setAcceptMode(operationMode);
+
+    if (saveDialog)
+    {
+        _dialog->setConfirmOverwrite(true);
+        _dialog->setFileMode(QFileDialog::AnyFile);
+    }
+}
+
+void KDE5FilePicker::setWinId(sal_uIntPtr winId) { _winId = winId; }
+
+bool KDE5FilePicker::eventFilter(QObject* o, QEvent* e)
+{
+    if (e->type() == QEvent::Show && o->isWidgetType())
+    {
+        auto* w = static_cast<QWidget*>(o);
+        if (!w->parentWidget() && w->isModal())
+        {
+            KWindowSystem::setMainWindow(w, _winId);
+            if (auto* fileWidget = w->findChild<KFileWidget*>({}, Qt::FindDirectChildrenOnly))
+                fileWidget->setCustomWidget(_extraControls);
+        }
+    }
+    return QObject::eventFilter(o, e);
+}
+
+#include <kde5_filepicker.moc>
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker.hxx	2018-03-02 13:47:33.410352563 +0100
@@ -0,0 +1,110 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+#include <QtCore/QObject>
+#include <QtCore/QString>
+#include <QtCore/QStringList>
+#include <QtCore/QHash>
+
+#include <sal/types.h>
+
+class QFileDialog;
+class QWidget;
+class QGridLayout;
+
+class KDE5FilePicker : public QObject
+{
+    Q_OBJECT
+protected:
+    //the dialog to display
+    QFileDialog* _dialog;
+
+    //running filter string to add to dialog
+    QStringList _filters;
+    // map of filter titles to full filter for selection
+    QHash<QString, QString> _titleToFilters;
+    // string to set the current filter
+    QString _currentFilter;
+
+    //mapping of SAL control ID's to created custom controls
+    QHash<sal_Int16, QWidget*> _customWidgets;
+
+    //widget to contain extra custom controls
+    QWidget* _extraControls;
+
+    //layout for extra custom controls
+    QGridLayout* _layout;
+
+    sal_uIntPtr _winId;
+
+    bool allowRemoteUrls;
+
+public:
+    explicit KDE5FilePicker(QObject* parent = nullptr);
+    ~KDE5FilePicker() override;
+
+    void enableFolderMode();
+
+    // XExecutableDialog functions
+    void setTitle(const QString& rTitle);
+    bool execute();
+
+    // XFilePicker functions
+    void setMultiSelectionMode(bool bMode);
+    void setDefaultName(const QString& rName);
+    void setDisplayDirectory(const QString& rDirectory);
+    QString getDisplayDirectory() const;
+
+    // XFilterManager functions
+    void appendFilter(const QString& rTitle, const QString& rFilter);
+    void setCurrentFilter(const QString& rTitle);
+    QString getCurrentFilter() const;
+
+    // XFilePickerControlAccess functions
+    void setValue(sal_Int16 nControlId, sal_Int16 nControlAction, bool rValue);
+    bool getValue(sal_Int16 nControlId, sal_Int16 nControlAction) const;
+    void enableControl(sal_Int16 nControlId, bool bEnable);
+    void setLabel(sal_Int16 nControlId, const QString& rLabel);
+    QString getLabel(sal_Int16 nControlId) const;
+
+    // XFilePicker2 functions
+    QList<QUrl> getSelectedFiles() const;
+
+    // XInitialization
+    void initialize(bool saveDialog);
+
+    //add a custom control widget to the file dialog
+    void addCheckBox(sal_Int16 nControlId, const QString& label, bool hidden);
+
+    void setWinId(sal_uIntPtr winId);
+
+private:
+    Q_DISABLE_COPY(KDE5FilePicker)
+
+protected:
+    bool eventFilter(QObject* watched, QEvent* event) override;
+
+Q_SIGNALS:
+    void filterChanged();
+    void selectionChanged();
+};
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.cxx	2018-03-02 13:47:33.403352546 +0100
@@ -0,0 +1,246 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "kde5_filepicker_ipc.hxx"
+
+#include <QSocketNotifier>
+#include <QUrl>
+#include <QThread>
+#include <QApplication>
+#include <QDebug>
+
+#include <iostream>
+
+#include "filepicker_ipc_commands.hxx"
+#include "kde5_filepicker.hxx"
+
+#include <rtl/ustring.h>
+
+void readIpcArg(std::istream& stream, QString& string)
+{
+    const auto buffer = readIpcStringArg(stream);
+    string = QString::fromUtf8(buffer.data(), buffer.size());
+}
+
+void sendIpcArg(std::ostream& stream, const QString& string)
+{
+    const auto utf8 = string.toUtf8();
+    sendIpcStringArg(stream, utf8.size(), utf8.data());
+}
+
+void sendIpcArg(std::ostream& stream, const QStringList& list)
+{
+    stream << static_cast<uint32_t>(list.size()) << ' ';
+    for (const auto& entry : list)
+    {
+        sendIpcArg(stream, entry);
+    }
+}
+
+FilePickerIpc::FilePickerIpc(KDE5FilePicker* filePicker, QObject* parent)
+    : QObject(parent)
+    , m_filePicker(filePicker)
+    , m_stdinNotifier(new QSocketNotifier(fileno(stdin), QSocketNotifier::Read, this))
+{
+    connect(m_stdinNotifier, &QSocketNotifier::activated, this, &FilePickerIpc::readCommands);
+}
+
+FilePickerIpc::~FilePickerIpc() = default;
+
+void FilePickerIpc::readCommands()
+{
+    while (readCommand())
+    {
+        // read next command
+    }
+}
+
+bool FilePickerIpc::readCommand()
+{
+    if (std::cin.eof())
+        return false;
+
+    uint64_t messageId = 0;
+    Commands command;
+    readIpcArgs(std::cin, messageId, command);
+
+    switch (command)
+    {
+        case Commands::SetTitle:
+        {
+            QString title;
+            readIpcArgs(std::cin, title);
+            m_filePicker->setTitle(title);
+            return true;
+        }
+        case Commands::SetWinId:
+        {
+            sal_uIntPtr winId = 0;
+            readIpcArgs(std::cin, winId);
+            m_filePicker->setWinId(winId);
+            return true;
+        }
+        case Commands::Execute:
+        {
+            sendIpcArgs(std::cout, messageId, m_filePicker->execute());
+            return true;
+        }
+        case Commands::SetMultiSelectionMode:
+        {
+            bool multiSelection = false;
+            readIpcArgs(std::cin, multiSelection);
+            m_filePicker->setMultiSelectionMode(multiSelection);
+            return true;
+        }
+        case Commands::SetDefaultName:
+        {
+            QString name;
+            readIpcArgs(std::cin, name);
+            m_filePicker->setDefaultName(name);
+            return true;
+        }
+        case Commands::SetDisplayDirectory:
+        {
+            QString dir;
+            readIpcArgs(std::cin, dir);
+            m_filePicker->setDisplayDirectory(dir);
+            return true;
+        }
+        case Commands::GetDisplayDirectory:
+        {
+            sendIpcArgs(std::cout, messageId, m_filePicker->getDisplayDirectory());
+            return true;
+        }
+        case Commands::GetSelectedFiles:
+        {
+            QStringList files;
+            for (auto const& url_ : m_filePicker->getSelectedFiles())
+            {
+                auto url = url_;
+                if (url.scheme() == QLatin1String("webdav")
+                    || url.scheme() == QLatin1String("webdavs"))
+                {
+                    // translate webdav and webdavs URLs into a format supported by LO
+                    url.setScheme(QLatin1String("vnd.sun.star.") + url.scheme());
+                }
+                else if (url.scheme() == QLatin1String("smb"))
+                {
+                    // clear the user name - the GIO backend does not support this apparently
+                    // when no username is available, it will ask for the password
+                    url.setUserName({});
+                }
+                files << url.toString();
+            }
+            sendIpcArgs(std::cout, messageId, files);
+            return true;
+        }
+        case Commands::AppendFilter:
+        {
+            QString title, filter;
+            readIpcArgs(std::cin, title, filter);
+            m_filePicker->appendFilter(title, filter);
+            return true;
+        }
+        case Commands::SetCurrentFilter:
+        {
+            QString title;
+            readIpcArgs(std::cin, title);
+            m_filePicker->setCurrentFilter(title);
+            return true;
+        }
+        case Commands::GetCurrentFilter:
+        {
+            sendIpcArgs(std::cout, messageId, m_filePicker->getCurrentFilter());
+            return true;
+        }
+        case Commands::SetValue:
+        {
+            sal_Int16 controlId = 0;
+            sal_Int16 nControlAction = 0;
+            bool value = false;
+            readIpcArgs(std::cin, controlId, nControlAction, value);
+            m_filePicker->setValue(controlId, nControlAction, value);
+            return true;
+        }
+        case Commands::GetValue:
+        {
+            sal_Int16 controlId = 0;
+            sal_Int16 nControlAction = 0;
+            readIpcArgs(std::cin, controlId, nControlAction);
+            sendIpcArgs(std::cout, messageId, m_filePicker->getValue(controlId, nControlAction));
+            return true;
+        }
+        case Commands::EnableControl:
+        {
+            sal_Int16 controlId = 0;
+            bool enabled = false;
+            readIpcArgs(std::cin, controlId, enabled);
+            m_filePicker->enableControl(controlId, enabled);
+            return true;
+        }
+        case Commands::SetLabel:
+        {
+            sal_Int16 controlId = 0;
+            QString label;
+            readIpcArgs(std::cin, controlId, label);
+            m_filePicker->setLabel(controlId, label);
+            return true;
+        }
+        case Commands::GetLabel:
+        {
+            sal_Int16 controlId = 0;
+            readIpcArgs(std::cin, controlId);
+            sendIpcArgs(std::cout, messageId, m_filePicker->getLabel(controlId));
+            return true;
+        }
+        case Commands::AddCheckBox:
+        {
+            sal_Int16 controlId = 0;
+            bool hidden = false;
+            QString label;
+            readIpcArgs(std::cin, controlId, hidden, label);
+            m_filePicker->addCheckBox(controlId, label, hidden);
+            return true;
+        }
+        case Commands::Initialize:
+        {
+            bool saveDialog = false;
+            readIpcArgs(std::cin, saveDialog);
+            m_filePicker->initialize(saveDialog);
+            return true;
+        }
+        case Commands::EnablePickFolderMode:
+        {
+            m_filePicker->enableFolderMode();
+            return true;
+        }
+        case Commands::Quit:
+        {
+            QCoreApplication::quit();
+            return false;
+        }
+    }
+    qWarning() << "unhandled command " << static_cast<uint16_t>(command);
+    QCoreApplication::exit(1);
+    return false;
+}
+
+#include <kde5_filepicker_ipc.moc>
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.hxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.hxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.hxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_filepicker_ipc.hxx	2018-03-02 13:47:33.403352546 +0100
@@ -0,0 +1,45 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#pragma once
+
+#include <QObject>
+
+class KDE5FilePicker;
+class WinIdEmbedder;
+class QSocketNotifier;
+
+class FilePickerIpc : public QObject
+{
+    Q_OBJECT
+public:
+    explicit FilePickerIpc(KDE5FilePicker* filePicker, QObject* parent = nullptr);
+    ~FilePickerIpc() override;
+
+private Q_SLOTS:
+    void readCommands();
+
+private:
+    bool readCommand();
+
+    KDE5FilePicker* m_filePicker = nullptr;
+    QSocketNotifier* m_stdinNotifier = nullptr;
+};
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_lo_filepicker_main.cxx libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_lo_filepicker_main.cxx
--- libreoffice-6.0.2.1/vcl/unx/gtk3_kde5/kde5_lo_filepicker_main.cxx	1970-01-01 01:00:00.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/gtk3_kde5/kde5_lo_filepicker_main.cxx	2018-03-02 13:47:33.405352551 +0100
@@ -0,0 +1,54 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/*
+ * This file is part of the LibreOffice project.
+ *
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+ *
+ * This file incorporates work covered by the following license notice:
+ *
+ *   Licensed to the Apache Software Foundation (ASF) under one or more
+ *   contributor license agreements. See the NOTICE file distributed
+ *   with this work for additional information regarding copyright
+ *   ownership. The ASF licenses this file to you under the Apache
+ *   License, Version 2.0 (the "License"); you may not use this file
+ *   except in compliance with the License. You may obtain a copy of
+ *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
+ */
+
+#include "kde5_filepicker.hxx"
+#include "kde5_filepicker_ipc.hxx"
+
+#include <QApplication>
+#include <QDebug>
+#include <QCommandLineParser>
+
+#include <config_version.h>
+
+int main(int argc, char** argv)
+{
+    QApplication::setOrganizationName("LibreOffice");
+    QApplication::setOrganizationDomain("libreoffice.org");
+    QApplication::setApplicationName(QStringLiteral("lo_kde5filepicker"));
+    QApplication::setQuitOnLastWindowClosed(false);
+    QApplication::setApplicationVersion(LIBO_VERSION_DOTTED);
+
+    QApplication app(argc, argv);
+
+    QCommandLineParser parser;
+    parser.setApplicationDescription(
+        QObject::tr("Helper executable for LibreOffice KDE/Plasma integration.\n"
+                    "Do not run this executable directly. Rather, use it indirectly via "
+                    "the gtk3_kde5 VCL plugin (SAL_USE_VCLPLUGIN=gtk3_kde5)."));
+    parser.addVersionOption();
+    parser.addHelpOption();
+    parser.process(app);
+
+    KDE5FilePicker filePicker;
+    FilePickerIpc ipc(&filePicker);
+
+    return QApplication::exec();
+}
+
+/* vim:set shiftwidth=4 softtabstop=4 expandtab: */
diff -Naur libreoffice-6.0.2.1/vcl/unx/kde5/KDE5SalDisplay.cxx libreoffice-6.0.2.1-p/vcl/unx/kde5/KDE5SalDisplay.cxx
--- libreoffice-6.0.2.1/vcl/unx/kde5/KDE5SalDisplay.cxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/kde5/KDE5SalDisplay.cxx	2018-03-02 13:47:33.362352450 +0100
@@ -58,7 +58,7 @@
     if (XEventsQueued( pDisp_, QueuedAfterReading ) == 0)
         return;
 
-    DBG_ASSERT( static_cast<SalYieldMutex*>(GetSalData()->m_pInstance->GetYieldMutex())->GetThreadId() ==
+    DBG_ASSERT( GetSalData()->m_pInstance->GetYieldMutex()->IsCurrentThread() ==
                 osl::Thread::getCurrentIdentifier(),
                 "will crash soon since solar mutex not locked in SalKDE5Display::Yield" );
 
diff -Naur libreoffice-6.0.2.1/vcl/unx/kde5/KDE5XLib.cxx libreoffice-6.0.2.1-p/vcl/unx/kde5/KDE5XLib.cxx
--- libreoffice-6.0.2.1/vcl/unx/kde5/KDE5XLib.cxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/kde5/KDE5XLib.cxx	2018-03-02 13:47:33.362352450 +0100
@@ -22,7 +22,7 @@
 #include <QtWidgets/QApplication>
 #include <QtWidgets/QFrame>
 #include <QtGui/QClipboard>
-#include <QtGui/QFrame>
+#include <QtWidgets/QFrame>
 #include <QtX11Extras/QX11Info>
 
 
@@ -208,7 +208,7 @@
 
 static gint gpoll_wrapper( GPollFD* ufds, guint nfds, gint timeout )
 {
-    SalYieldMutexReleaser release; // release YieldMutex (and re-acquire at block end)
+    SolarMutexReleaser release; // release YieldMutex (and re-acquire at block end)
     return old_gpoll( ufds, nfds, timeout );
 }
 #endif
@@ -304,7 +304,7 @@
         // release the yield lock to prevent deadlock with the main thread
         // (it's ok to release it here, since even normal processYield() would
         // temporarily do it while checking for new events)
-        SalYieldMutexReleaser aReleaser;
+        SolarMutexReleaser aReleaser;
         Q_EMIT processYieldSignal( bWait, bHandleAllCurrentEvents );
         return false;
     }
@@ -370,10 +370,10 @@
     QAbstractEventDispatcher::instance( qApp->thread())->wakeUp(); // main thread event loop
 }
 
-void KDE5XLib::PostUserEvent()
+void KDE5XLib::TriggerUserEventProcessing()
 {
     if( !m_isGlibEventLoopType )
-        return SalXLib::PostUserEvent();
+        return SalXLib::TriggerUserEventProcessing();
     QApplication::postEvent(this, new QEvent(QEvent::Type( m_postUserEventId )));
 }
 
@@ -394,9 +394,11 @@
 {
 #if QT5_HAVE_GLIB
     if( qApp->thread() != QThread::currentThread()) {
-        SalYieldMutexReleaser aReleaser;
+        SolarMutexReleaser aReleaser;
         return Q_EMIT createFilePickerSignal( xMSF );
     }
+
+    return nullptr;
     //return uno::Reference< ui::dialogs::XFilePicker2 >( new KDE4FilePicker( xMSF ) );
 #else
     (void)xMSF;
diff -Naur libreoffice-6.0.2.1/vcl/unx/kde5/KDE5XLib.hxx libreoffice-6.0.2.1-p/vcl/unx/kde5/KDE5XLib.hxx
--- libreoffice-6.0.2.1/vcl/unx/kde5/KDE5XLib.hxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/kde5/KDE5XLib.hxx	2018-03-02 13:47:33.362352450 +0100
@@ -84,7 +84,7 @@
         virtual void StartTimer( sal_uLong nMS ) override;
         virtual void StopTimer() override;
         virtual void Wakeup() override;
-        virtual void PostUserEvent() override;
+        virtual void TriggerUserEventProcessing();
 
         void doStartup();
         bool allowKdeDialogs() { return m_allowKdeDialogs; }
diff -Naur libreoffice-6.0.2.1/vcl/unx/kde5/main.cxx libreoffice-6.0.2.1-p/vcl/unx/kde5/main.cxx
--- libreoffice-6.0.2.1/vcl/unx/kde5/main.cxx	2018-02-22 18:45:41.000000000 +0100
+++ libreoffice-6.0.2.1-p/vcl/unx/kde5/main.cxx	2018-03-02 13:47:33.362352450 +0100
@@ -17,7 +17,7 @@
  *   the License at http://www.apache.org/licenses/LICENSE-2.0 .
  */
 
-#include <QtGui/QApplication>
+#include <QtWidgets/QApplication>
 
 #include "KDE5Data.hxx"
 #include "KDE5SalInstance.hxx"
